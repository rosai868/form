<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>7è¥¿ã‚·ãƒ•ãƒˆå¸Œæœ›</title>

<script src="firebase-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: "Yu Gothic", YuGothic, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: #FFFBF7; padding: 20px; color: #5D4037; }
.container { max-width: 1200px; margin: 0 auto; background: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07); border: 1px solid #F0EAE4; }
h1 { text-align: center; color: #5D4037; margin-bottom: 30px; font-size: 24px; font-weight: 600; }
h2 { text-align: center; color: #5D4037; margin-bottom: 20px; font-size: 20px; font-weight: 500; }
.hidden { display: none !important; }
.loading { text-align: center; padding: 50px; font-size: 18px; color: #777; }
.login-container { max-width: 400px; margin: 50px auto; }
.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 8px; color: #5D4037; font-weight: 600; }
input[type="text"], input[type="password"], select { width: 100%; padding: 12px; border: 1px solid #F0EAE4; border-radius: 8px; font-size: 14px; background: #FFFBF7; color: #5D4037; }
input:focus { outline: none; border-color: #80CBC4; box-shadow: 0 0 0 3px rgba(128, 203, 196, 0.2); }
button { width: 100%; padding: 12px; background: #80CBC4; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
button:hover { background: #4DB6AC; }
button:disabled { background: #cccccc; cursor: not-allowed; }
.timer { background: #F8F8F8; border: 1px solid #F0EAE4; color: #777; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: right; font-size: 12px; }
.timer-display { font-size: 14px; font-weight: 600; margin-top: 5px; color: #5D4037; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #00897B 0%, #4DB6AC 100%); border-radius: 16px; box-shadow: 0 4px 15px rgba(0, 137, 123, 0.3); }
.calendar-header h2 { color: white; font-size: 22px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.calendar-header button { width: auto; padding: 10px 24px; background: rgba(255,255,255,0.9); color: #00897B; border-radius: 25px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.calendar-header button:hover { background: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
#calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; background: transparent; border: none; border-radius: 12px; padding: 10px; background: #F8F9FA; }
.weekday-header { background: transparent; color: #5D4037; padding: 12px 5px; text-align: center; font-weight: 700; font-size: 13px; }
.weekday-header.sunday { color: #E57373; }
.weekday-header.saturday { color: #64B5F6; }
.calendar-day { background: white; height: 75px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; cursor: pointer; position: relative; user-select: none; transition: all 0.2s ease; border: none; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding-top: 8px; }
.calendar-day.selected { box-sizing: border-box; }
.calendar-day:hover:not(.disabled):not(.empty) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.calendar-day.empty { background: transparent; cursor: default; box-shadow: none; }
.calendar-day.sunday { background: #FFF5F5; }
.calendar-day.saturday { background: #F5F8FF; }
.calendar-day.holiday { background: linear-gradient(135deg, #FFF5F5 0%, #FFE8E8 100%); }
.calendar-day.disabled { background: #F5F5F5; color: #BDBDBD; cursor: not-allowed; box-shadow: none; }
.calendar-day-number { font-size: 16px; font-weight: 700; position: relative; top: 0; left: 0; color: #333; }
.calendar-day.sunday .calendar-day-number { color: #E57373; }
.calendar-day.saturday .calendar-day-number { color: #64B5F6; }
.calendar-day-request { position: absolute; bottom: 8px; font-size: 10px; font-weight: 700; height: 24px; min-width: 24px; padding: 0 6px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.request-type-ä¼‘ { color: white; background: linear-gradient(135deg, #EF5350 0%, #E53935 100%); border: none; }
.request-type-å¹´ { color: white; background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%); border: none; }
.request-type-å‡º { color: white; background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); border: none; }
.request-type-æ—¥ { color: white; background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%); border: none; }
.request-type-ç‰¹ { color: white; background: linear-gradient(135deg, #9575CD 0%, #7E57C2 100%); border: none; }
.request-type-AM { color: white; background: linear-gradient(135deg, #29B6F6 0%, #039BE5 100%); border: none; }
.request-type-PM { color: white; background: linear-gradient(135deg, #5C6BC0 0%, #3F51B5 100%); border: none; }
.request-type-å¤ { color: white; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); border: none; }
.calendar-day.selected { border: 2px solid #80CBC4; background-color: #E0F2F1; }
.calendar-day.selected-ä¼‘ { border: 2px solid #EF5350; background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%); }
.calendar-day.selected-å¹´ { border: 2px solid #42A5F5; background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); }
.calendar-day.selected-å‡º { border: 2px solid #FFA726; background: linear-gradient(135deg, #FFF8E1 0%, #FFE0B2 100%); }
.calendar-day.selected-æ—¥ { border: 2px solid #66BB6A; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
.calendar-day.selected-ç‰¹ { border: 2px solid #9575CD; background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); }
.calendar-day.selected-AM { border: 2px solid #29B6F6; background: linear-gradient(135deg, #E1F5FE 0%, #B3E5FC 100%); }
.calendar-day.selected-PM { border: 2px solid #5C6BC0; background: linear-gradient(135deg, #E8EAF6 0%, #C5CAE9 100%); }
.calendar-day.selected-å¤ { border: 2px solid #FF9800; background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); }
.request-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 25px 0; padding: 20px; background: #F8F9FA; border-radius: 16px; }
.request-button { padding: 16px 8px; text-align: center; border: none; border-radius: 12px; cursor: pointer; background: white; font-weight: 600; color: #5D4037; transition: all 0.25s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center; gap: 8px; }
.request-button:hover:not(.active) { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
.request-button .icon { font-size: 24px; }
.request-button .label { font-size: 12px; line-height: 1.3; }
.request-button.active { transform: scale(1.02); }
.request-button.active[data-type="ä¼‘"] { background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%); color: #C62828; box-shadow: 0 4px 15px rgba(239, 83, 80, 0.3); }
.request-button.active[data-type="å¹´"] { background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); color: #1565C0; box-shadow: 0 4px 15px rgba(66, 165, 245, 0.3); }
.request-button.active[data-type="å‡º"] { background: linear-gradient(135deg, #FFF8E1 0%, #FFE0B2 100%); color: #E65100; box-shadow: 0 4px 15px rgba(255, 167, 38, 0.3); }
.request-button.active[data-type="æ—¥"] { background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); color: #2E7D32; box-shadow: 0 4px 15px rgba(102, 187, 106, 0.3); }
.request-button.active[data-type="ç‰¹"] { background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); color: #6A1B9A; box-shadow: 0 4px 15px rgba(149, 117, 205, 0.3); }
.request-button.active[data-type="AM"] { background: linear-gradient(135deg, #E1F5FE 0%, #B3E5FC 100%); color: #0277BD; box-shadow: 0 4px 15px rgba(41, 182, 246, 0.3); }
.request-button.active[data-type="PM"] { background: linear-gradient(135deg, #E8EAF6 0%, #C5CAE9 100%); color: #283593; box-shadow: 0 4px 15px rgba(92, 107, 192, 0.3); }
.request-button.active[data-type="å¤"] { background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); color: #E65100; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3); }
.selected-dates { margin-top: 25px; padding: 20px; background: white; border-radius: 16px; border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
.selected-dates h3 { color: #00897B; font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.selected-dates h3::before { content: 'ğŸ“‹'; }
.selected-date-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin: 8px 0; background: #F8F9FA; border-radius: 10px; border: none; transition: all 0.2s ease; }
.selected-date-item:hover { background: #F0F0F0; }
.selected-date-item button { width: auto; padding: 6px 16px; background: linear-gradient(135deg, #FFAB91 0%, #FF8A65 100%); font-size: 12px; border-radius: 20px; box-shadow: 0 2px 6px rgba(255, 138, 101, 0.3); }
.selected-date-item button:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(255, 138, 101, 0.4); }
.error-message { color: #EF5350; margin-top: 10px; text-align: center; }
.success-message { color: #66BB6A; margin-top: 10px; text-align: center; }
.admin-table-container { overflow-x: auto; margin-top: 20px; border: 1px solid #E0E0E0; border-radius: 8px; }
.admin-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.admin-table th, .admin-table td { border: 1px solid #E0E0E0; padding: 8px 5px; text-align: center; }
.admin-table th { background: #80CBC4; color: white; font-weight: 600; position: sticky; top: 0; border-color: #80CBC4; }
.admin-table td:first-child { text-align: center; font-weight: bold; background: #F8F8F8; position: sticky; left: 0; min-width: 30px; }
.admin-table td:nth-child(2) { text-align: center; font-weight: bold; background: #F8F8F8; position: sticky; left: 30px; min-width: 35px; }
.admin-table td:nth-child(3) { text-align: left; padding-left: 10px; font-weight: bold; background: #F8F8F8; position: sticky; left: 65px; min-width: 75px; white-space: nowrap; }
.logout-button { background: #FFAB91; margin-top: 20px; }
.logout-button:hover { background: #FF8A65; }
.password-change-button { background: #FFD54F; color: #5D4037; margin-top: 10px; }
.password-change-button:hover { background: #FFCA28; }

.schedule-table {
width: 100%;
border-collapse: collapse;
margin-top: 20px;
font-size: 11px;
table-layout: fixed;
}
.schedule-table th {
color: #333;
font-weight: 600;
}
.schedule-table th,
.schedule-table td {
border: 1px solid #E0E0E0;
padding: 4px;
text-align: center;
width: 2.8%;
}
.schedule-table th:first-child,
.schedule-table td:first-child {
width: 10%;
text-align: left;
padding-left: 5px;
font-weight: 600;
background: #F8F8F8;
position: sticky;
left: 0;
}
.schedule-table th {
background: #80CBC4;
color: white;
font-weight: 600;
}
.shift-æ—¥ { background: #E8F5E9; color: #388E3C; }
.shift-æº– { background: #E1F5FE; color: #0277BD; }
.shift-æ·± { background: #E8EAF6; color: #303F9F; }
.shift-å¤œ { background: #E8EAF6; color: #303F9F; }  /* äº’æ›æ€§å¯¾å¿œ */
.shift-ä¼‘, .shift-å¹´, .shift-ç‰¹, .shift-å¤, .shift-AM, .shift-PM {
background: #F5F5F5; color: #757575;
}

.swap-candidate {
padding: 12px;
margin: 8px 0;
border: 2px solid #E0E0E0;
border-radius: 8px;
cursor: pointer;
transition: all 0.2s;
display: flex;
justify-content: space-between;
align-items: center;
}

.swap-candidate:hover {
border-color: #1976D2;
background: #E3F2FD;
}

.swap-candidate.unavailable {
opacity: 0.5;
cursor: not-allowed;
border-color: #FFCDD2;
}

.swap-candidate.unavailable:hover {
border-color: #FFCDD2;
background: white;
}

.candidate-info {
flex: 1;
}

.candidate-name {
font-weight: bold;
font-size: 16px;
margin-bottom: 4px;
}

.candidate-status {
font-size: 13px;
color: #666;
}

.swap-actions {
display: flex;
gap: 8px;
}

.swap-btn {
padding: 6px 12px;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 13px;
transition: all 0.2s;
}

.swap-btn.exchange {
background: #4CAF50;
color: white;
}

.swap-btn.exchange:hover {
background: #388E3C;
}

.swap-btn.transfer {
background: #FF9800;
color: white;
}

.swap-btn.transfer:hover {
background: #F57C00;
}

/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é–¢é€£ */
.progress-container {
background: #F5F5F5;
border: 1px solid #E0E0E0;
border-radius: 8px;
padding: 20px;
margin-top: 20px;
}

.progress-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
}

.progress-status {
font-size: 16px;
font-weight: bold;
color: #00897B;
}

.progress-time {
font-size: 14px;
color: #666;
}

.progress-bar-container {
width: 100%;
height: 30px;
background: #E0E0E0;
border-radius: 15px;
overflow: hidden;
position: relative;
margin-bottom: 15px;
}

.progress-bar {
height: 100%;
background: linear-gradient(90deg, #4CAF50, #81C784);
border-radius: 15px;
transition: width 0.5s ease;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: bold;
font-size: 13px;
}

.progress-details {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 15px;
margin-top: 15px;
}

.progress-detail-item {
background: white;
padding: 12px;
border-radius: 6px;
border: 1px solid #E0E0E0;
text-align: center;
}

.progress-detail-label {
font-size: 12px;
color: #666;
margin-bottom: 5px;
}

.progress-detail-value {
font-size: 20px;
font-weight: bold;
color: #00897B;
}

.progress-detail-value.score {
color: #1976D2;
}

.progress-detail-value.time {
color: #F57C00;
}

@keyframes pulse {
0%, 100% {
opacity: 1;
}
50% {
opacity: 0.7;
}
}

.progress-status.processing {
animation: pulse 1.5s infinite;
}

.spinner {
display: inline-block;
width: 14px;
height: 14px;
border: 2px solid #E0E0E0;
border-top-color: #00897B;
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

@keyframes slideIn {
from {
transform: translateX(400px);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}

@keyframes slideOut {
from {
transform: translateX(0);
opacity: 1;
}
to {
transform: translateX(400px);
opacity: 0;
}
}

/* å¸Œæœ›ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
.admin-table {
table-layout: fixed;
font-size: 11px;
}
.admin-table th, .admin-table td {
padding: 3px 1px;
text-align: center;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}
/* IDåˆ— - æœ€å°é™ã« */
.admin-table td:first-child,
.admin-table th:first-child { 
width: 22px; 
min-width: 22px;
max-width: 22px;
font-size: 10px;
}
/* ãƒãƒ¼ãƒ åˆ— - æœ€å°é™ã« */
.admin-table td:nth-child(2),
.admin-table th:nth-child(2) { 
width: 22px; 
min-width: 22px;
max-width: 22px;
font-size: 10px;
}
/* åå‰åˆ— - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
.admin-table td:nth-child(3),
.admin-table th:nth-child(3) { 
width: 50px; 
min-width: 50px;
max-width: 50px;
text-align: left;
padding-left: 3px;
font-size: 10px;
}
/* æ—¥ä»˜åˆ— */
.admin-table th:nth-child(n+4),
.admin-table td:nth-child(n+4) {
width: 22px;
min-width: 22px;
max-width: 24px;
font-size: 10px;
}
</style>
</head>
<body>

<div id="loadingSection" class="container">
<div class="loading">
<p>ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...</p>
<p style="font-size: 14px; margin-top: 10px;">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
</div>
</div>

<div id="loginSection" class="container login-container hidden">
<h1>7è¥¿ã‚·ãƒ•ãƒˆå¸Œæœ›</h1>
<div class="form-group">
<label for="userId">ID</label>
<input type="text" id="userId" placeholder="IDã‚’å…¥åŠ›">
</div>
<div class="form-group">
<label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
<input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
</div>
<button onclick="login()" id="loginButton">ãƒ­ã‚°ã‚¤ãƒ³</button>
<div style="margin-top: 20px; padding: 15px; background: #FFFBF7; border-radius: 8px; font-size: 12px; color: #777; line-height: 1.6;">
<p style="margin: 5px 0;">â€» IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã¯å¸«é•·ã«é€£çµ¡ã—ã¦ãã ã•ã„</p>
<p style="margin: 5px 0;">â€» ç· ã‚åˆ‡ã‚Šã¯æ¯æœˆ7æ—¥ã®åˆå‰9:00ã§ã™</p>
</div>
<div id="loginError" class="error-message"></div>
</div>

<div id="changePasswordSection" class="container login-container hidden">
<h2>åˆå›ãƒ­ã‚°ã‚¤ãƒ³ - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
<p style="margin-bottom: 20px;">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ¡ã®æ•°å­—ï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
<div class="form-group">
<label for="newPassword">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
<input type="password" id="newPassword" placeholder="6æ¡ã®æ•°å­—" maxlength="6">
</div>
<div class="form-group">
<label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
<input type="password" id="confirmPassword" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›" maxlength="6">
</div>
<button onclick="changePassword()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
<div id="passwordError" class="error-message"></div>
</div>

<div id="mainSection" class="container hidden">
<h1 style="background: linear-gradient(135deg, #00897B 0%, #4DB6AC 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 28px;">ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›</h1>
<div id="welcomeMessage" style="text-align: center; margin-bottom: 20px;"></div>

<div class="timer" style="background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%); border: none; border-radius: 12px; padding: 16px 20px; box-shadow: 0 2px 10px rgba(255, 193, 7, 0.2);">
<div style="display: flex; align-items: center; gap: 8px; color: #F57C00;"><i class="fas fa-clock"></i> ç· åˆ‡ã¾ã§æ®‹ã‚Šæ™‚é–“</div>
<div id="countdown" class="timer-display" style="font-size: 18px; color: #E65100;">è¨ˆç®—ä¸­...</div>
</div>

<div class="calendar-header">
<button onclick="previousMonth()"><i class="fas fa-chevron-left"></i> å‰æœˆ</button>
<h2 id="currentMonth"></h2>
<button onclick="nextMonth()">ç¿Œæœˆ <i class="fas fa-chevron-right"></i></button>
</div>

<div id="calendar"></div>

<div style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); padding: 16px 20px; border-radius: 12px; margin: 20px 0; display: flex; align-items: center; gap: 12px;">
<i class="fas fa-info-circle" style="font-size: 24px; color: #2E7D32;"></i>
<div style="color: #1B5E20; font-size: 14px;">
<strong>ä½¿ã„æ–¹:</strong> ä¸‹ã®å¸Œæœ›ç¨®åˆ¥ã‚’é¸æŠã—ã¦ã‹ã‚‰ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„
</div>
</div>

<div class="request-buttons">
<div class="request-button" onclick="setRequestType('ä¼‘')" data-type="ä¼‘">
<span class="icon">ğŸ </span>
<span class="label">ä¼‘ã¿å¸Œæœ›</span>
</div>
<div class="request-button" onclick="setRequestType('å¹´')" data-type="å¹´">
<span class="icon">ğŸŒ´</span>
<span class="label">å¹´ä¼‘å¸Œæœ›</span>
</div>
<div class="request-button" onclick="setRequestType('å‡º')" data-type="å‡º">
<span class="icon">âœˆï¸</span>
<span class="label">å‡ºå¼µ</span>
</div>
<div class="request-button" onclick="setRequestType('æ—¥')" data-type="æ—¥">
<span class="icon">â˜€ï¸</span>
<span class="label">æ—¥å‹¤å¸Œæœ›</span>
</div>
<div class="request-button" onclick="setRequestType('ç‰¹')" data-type="ç‰¹">
<span class="icon">â­</span>
<span class="label">ç‰¹ä¼‘å¸Œæœ›</span>
</div>
<div class="request-button" onclick="setRequestType('AM')" data-type="AM">
<span class="icon">ğŸŒ…</span>
<span class="label">åˆå‰ä¼‘</span>
</div>
<div class="request-button" onclick="setRequestType('PM')" data-type="PM">
<span class="icon">ğŸŒ‡</span>
<span class="label">åˆå¾Œä¼‘</span>
</div>
<div class="request-button" onclick="setRequestType('å¤')" data-type="å¤">
<span class="icon">ğŸ–ï¸</span>
<span class="label">å¤ä¼‘ã¿</span>
</div>
</div>

<div class="selected-dates">
<h3>é¸æŠæ¸ˆã¿ã®å¸Œæœ›</h3>
<div id="selectedDatesList"></div>
</div>

<button onclick="submitRequests()" id="submitButton" style="background: linear-gradient(135deg, #00897B 0%, #4DB6AC 100%); padding: 16px 32px; font-size: 16px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0, 137, 123, 0.4); margin-top: 20px;">
<i class="fas fa-paper-plane" style="margin-right: 8px;"></i>å¸Œæœ›ã‚’æå‡ºã™ã‚‹
</button>

<div id="submissionStatus" class="selected-dates" style="margin-top: 20px;">
<h3>æå‡ºçŠ¶æ³</h3>
<div id="submissionStatusContent"></div>
</div>

<div id="submitMessage" style="margin-top: 10px;"></div>

<button id="adminButton" onclick="showAdminSection()" class="logout-button hidden" style="background: #6c757d; margin-top: 10px;">ç®¡ç†è€…ç”»é¢ã¸</button>

<button onclick="showChangePasswordForm()" class="logout-button password-change-button">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹</button>
<button onclick="logout()" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

<div id="adminSection" class="container hidden">
<h1>ç®¡ç†è€…ç”»é¢</h1>

<button onclick="showMainSection()" style="width: auto; padding: 10px 20px; margin-bottom: 20px; background: #6c757d;">è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆç™»éŒ²ã«æˆ»ã‚‹</button>

<div style="display: flex; gap: 10px; margin-bottom: 20px;">
<button onclick="showPreviousMonth()" style="width: auto; padding: 10px 20px;">å‰æœˆ</button>
<button onclick="showCurrentMonth()" style="width: auto; padding: 10px 20px;">ä»Šæœˆ</button>
<button onclick="showNextMonth()" style="width: auto; padding: 10px 20px;">ç¿Œæœˆ</button>
</div>

<h2 id="adminMonth"></h2>

<div class="admin-table-container">
<table class="admin-table">
<thead>
<tr id="adminTableHeader"></tr>
</thead>
<tbody id="adminTableBody"></tbody>
</table>
</div>

<button onclick="exportToCSV()" style="margin-top: 20px;">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>

<div style="margin-top: 30px; padding: 20px; background: #FFFBF7; border: 1px solid #F0EAE4; border-radius: 8px;">
<h3 style="font-size: 16px; margin-bottom: 15px; color: #5D4037;">
<i class="fas fa-magic" style="color: #80CBC4;"></i>
å‹¤å‹™è¡¨ è‡ªå‹•ä½œæˆ
</h3>
<p style="font-size: 13px; color: #777; margin-bottom: 15px;">
ç¾åœ¨è¡¨ç¤ºä¸­ã®æœˆï¼ˆYYYYå¹´MMæœˆï¼‰ã®å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€å‹¤å‹™è¡¨ã®æ¡ˆã‚’ä½œæˆã—ã¾ã™ã€‚<br>
å‡¦ç†ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
<strong style="color: #2E7D32;">â€» ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚ã€çµæœã¯ä¿å­˜ã•ã‚Œã¾ã™ã€‚</strong>
</p>

<!-- â˜…â˜…â˜… åˆ¶ç´„è¨­å®šãƒ‘ãƒãƒ« â˜…â˜…â˜… -->
<div id="constraint-settings" style="background: #FAFAFA; border: 1px solid #E0E0E0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<h4 style="margin: 0; color: #333; font-size: 14px;">
<i class="fas fa-sliders-h"></i> åˆ¶ç´„è¨­å®š
</h4>
<button id="constraint-toggle-btn" style="background: #757575; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
<i class="fas fa-chevron-down"></i> è©³ç´°ã‚’è¡¨ç¤º
</button>
</div>

<div id="constraint-details" style="display: none;">
<p style="font-size: 12px; color: #666; margin-bottom: 10px;">
è§£ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€åˆ¶ç´„ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
</p>

<!-- äººæ•°ãƒ»å›æ•°åˆ¶ç´„ï¼ˆé‡è¦ï¼‰ -->
<div style="background: #FFF3E0; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
<strong style="font-size: 12px; color: #E65100;">âš ï¸ äººæ•°ãƒ»å›æ•°åˆ¶ç´„ï¼ˆå¤–ã™ã¨å‹¤å‹™è¡¨ã¨ã—ã¦ä¸å®Œå…¨ã«ãªã‚‹å¯èƒ½æ€§ï¼‰</strong>
<div style="display: grid; grid-template-columns: 1fr; gap: 6px; font-size: 11px; margin-top: 8px;">

<label style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border: 1px solid #FFCC80; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-night-count" checked>
<span>æº–+æ·±ã¯7ã€œ8å›/æœˆ</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border: 1px solid #FFCC80; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-staff-count" checked>
<span>æ—¥å‹¤ãƒ»æº–å¤œãƒ»æ·±å¤œã®äººæ•°é…ç½®</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border: 1px solid #FFCC80; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-team-balance" checked>
<span>ãƒãƒ¼ãƒ ãƒãƒ©ãƒ³ã‚¹ï¼ˆA/Bäººæ•°ï¼‰</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border: 1px solid #FFCC80; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-leader-required" checked>
<span>ãƒªãƒ¼ãƒ€ãƒ¼å¿…é ˆé…ç½®</span>
</label>

</div>
</div>

<!-- ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¶ç´„ -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">

<label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: white; border: 1px solid #E0E0E0; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-jun-kyuu-shin" checked>
<span>æº–ä¼‘æ·±ãƒ»æ·±ä¼‘æº–ã®ç¦æ­¢</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: white; border: 1px solid #E0E0E0; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-kyuu-kyuu-shin" checked>
<span>ä¼‘ä¼‘æ·±ã®ç¦æ­¢</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: white; border: 1px solid #E0E0E0; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-day-4-consecutive" checked>
<span>æ—¥å‹¤ã¯4é€£ç¶šã¾ã§</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: white; border: 1px solid #E0E0E0; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-night-interval" checked>
<span>æ·±å¤œé–“éš”5æ—¥ä»¥ä¸Š</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: white; border: 1px solid #E0E0E0; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-jun-before-rest" checked>
<span>æº–å¤œå‰ã®ä¼‘ã¿ã¯1ã¤ã¾ã§</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: white; border: 1px solid #E0E0E0; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-jun-to-shin" checked>
<span>æº–å¤œâ†’æ·±å¤œã®ç¦æ­¢</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: white; border: 1px solid #E0E0E0; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-day-to-shin" checked>
<span>æ—¥å‹¤â†’æ·±å¤œã®ç¦æ­¢</span>
</label>

<label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: white; border: 1px solid #E0E0E0; border-radius: 4px; cursor: pointer;">
<input type="checkbox" id="constraint-pattern-bonus" checked>
<span>æº–æº–ä¼‘æ·±æ·±ä¼‘ãƒ‘ã‚¿ãƒ¼ãƒ³æ¨å¥¨</span>
</label>

</div>

<div style="margin-top: 10px; text-align: right;">
<button id="reset-constraints-btn" style="background: #9E9E9E; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 5px;">
<i class="fas fa-undo"></i> å…¨ã¦ã‚ªãƒ³
</button>
<button id="relax-constraints-btn" style="background: #FF9800; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
<i class="fas fa-bolt"></i> ç·©å’Œãƒ¢ãƒ¼ãƒ‰
</button>
</div>
</div>
</div>

<div style="display: flex; gap: 10px; margin-bottom: 15px;">
<button id="generate-schedule-btn" style="background: #00897B; flex: 1;">
<i class="fas fa-magic"></i> æ–°è¦ä½œæˆ
</button>
<button id="load-schedule-btn" style="background: #1976D2; flex: 1;">
<i class="fas fa-folder-open"></i> ä¿å­˜æ¸ˆã¿ã‚’èª­ã¿è¾¼ã‚€
</button>
<button onclick="exportScheduleToCSV()" style="background: #4CAF50; flex: 1;">
<i class="fas fa-file-csv"></i> CSVå‡ºåŠ›
</button>
</div>

<div id="schedule-results" style="margin-top: 20px;"></div>
</div>

<div style="margin-top: 30px; padding: 20px; background: #F8F8F8; border: 1px solid #F0EAE4; border-radius: 8px; font-size: 13px; color: #777;">
<h3 style="font-size: 16px; margin-bottom: 15px; color: #5D4037;">ğŸ”’ è·å“¡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</h3>
<p>
è·å“¡ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã¯ã€
<strong>Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€ŒAuthenticationã€</strong>
ç”»é¢ã‹ã‚‰ã€è©²å½“ã®è·å“¡ï¼ˆä¾‹: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4d7c0d2c3d3d632e2220">[email&#160;protected]</a>ï¼‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚
</p>
</div>

<button onclick="showChangePasswordForm()" class="logout-button password-change-button">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹</button>
<button onclick="logout()" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

<!-- â˜…å‹¤å‹™äº¤æ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="shift-swap-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
<div style="background: white; max-width: 800px; margin: 50px auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
<div style="background: #1976D2; color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
<h3 style="margin: 0;">å‹¤å‹™äº¤æ›ãƒ»è­²æ¸¡</h3>
<button onclick="closeSwapModal()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
</div>

<div id="swap-modal-content" style="padding: 20px;">
<!-- å‹•çš„ã«ç”Ÿæˆ -->
</div>
</div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ============================================
// â˜…â˜…â˜… åˆ¶ç´„è¨­å®šé–¢é€£ã®é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ â˜…â˜…â˜…
// ============================================

function toggleConstraintPanel() {
    const details = document.getElementById('constraint-details');
    const btn = document.getElementById('constraint-toggle-btn');
    if (!details || !btn) {
        console.error('åˆ¶ç´„ãƒ‘ãƒãƒ«ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    if (details.style.display === 'none') {
        details.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-chevron-up"></i> è©³ç´°ã‚’éš ã™';
    } else {
        details.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-chevron-down"></i> è©³ç´°ã‚’è¡¨ç¤º';
    }
}

function resetConstraints() {
    // äººæ•°ãƒ»å›æ•°åˆ¶ç´„
    document.getElementById('constraint-night-count').checked = true;
    document.getElementById('constraint-staff-count').checked = true;
    document.getElementById('constraint-team-balance').checked = true;
    document.getElementById('constraint-leader-required').checked = true;
    // ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¶ç´„
    document.getElementById('constraint-jun-kyuu-shin').checked = true;
    document.getElementById('constraint-kyuu-kyuu-shin').checked = true;
    document.getElementById('constraint-day-4-consecutive').checked = true;
    document.getElementById('constraint-night-interval').checked = true;
    document.getElementById('constraint-jun-before-rest').checked = true;
    document.getElementById('constraint-jun-to-shin').checked = true;
    document.getElementById('constraint-day-to-shin').checked = true;
    document.getElementById('constraint-pattern-bonus').checked = true;
}

function relaxConstraints() {
    // äººæ•°ãƒ»å›æ•°åˆ¶ç´„ã¯ç¶­æŒ
    document.getElementById('constraint-night-count').checked = true;
    document.getElementById('constraint-staff-count').checked = true;
    document.getElementById('constraint-team-balance').checked = false;  // ã‚ªãƒ•
    document.getElementById('constraint-leader-required').checked = false;  // ã‚ªãƒ•
    // ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¶ç´„
    document.getElementById('constraint-jun-kyuu-shin').checked = true;
    document.getElementById('constraint-kyuu-kyuu-shin').checked = true;
    document.getElementById('constraint-day-4-consecutive').checked = true;
    document.getElementById('constraint-night-interval').checked = false;
    document.getElementById('constraint-jun-before-rest').checked = false;
    document.getElementById('constraint-jun-to-shin').checked = false;
    document.getElementById('constraint-day-to-shin').checked = false;
    document.getElementById('constraint-pattern-bonus').checked = false;
    alert('ç·©å’Œãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šã—ã¾ã—ãŸã€‚ãƒãƒ¼ãƒ ãƒãƒ©ãƒ³ã‚¹ãƒ»ãƒªãƒ¼ãƒ€ãƒ¼å¿…é ˆãƒ»æ·±å¤œé–“éš”ç­‰ã‚’ã‚ªãƒ•ã«ã—ã¾ã—ãŸã€‚');
}

function getConstraintSettings() {
    return {
        // äººæ•°ãƒ»å›æ•°åˆ¶ç´„
        nightCount: document.getElementById('constraint-night-count')?.checked ?? true,
        staffCount: document.getElementById('constraint-staff-count')?.checked ?? true,
        teamBalance: document.getElementById('constraint-team-balance')?.checked ?? true,
        leaderRequired: document.getElementById('constraint-leader-required')?.checked ?? true,
        // ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¶ç´„
        junKyuuShin: document.getElementById('constraint-jun-kyuu-shin')?.checked ?? true,
        kyuuKyuuShin: document.getElementById('constraint-kyuu-kyuu-shin')?.checked ?? true,
        day4Consecutive: document.getElementById('constraint-day-4-consecutive')?.checked ?? true,
        nightInterval: document.getElementById('constraint-night-interval')?.checked ?? true,
        junBeforeRest: document.getElementById('constraint-jun-before-rest')?.checked ?? true,
        junToShin: document.getElementById('constraint-jun-to-shin')?.checked ?? true,
        dayToShin: document.getElementById('constraint-day-to-shin')?.checked ?? true,
        patternBonus: document.getElementById('constraint-pattern-bonus')?.checked ?? true
    };
}

// ============================================
// Firebaseã®è¨­å®š
// ============================================

let auth = null;
let firestore = null;

function initializeFirebase() {
try {
if (typeof firebaseConfig === 'undefined' || !firebaseConfig.apiKey) {
console.error('firebase-config.js ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ã‹ã€ä¸­èº«ãŒç©ºã§ã™ã€‚');
alert('Firebaseã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«(firebase-config.js)ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚');
return false;
}

firebase.initializeApp(firebaseConfig);
auth = firebase.auth();
firestore = firebase.firestore();
firestore.settings({ persistence: false });

console.log('FirebaseåˆæœŸåŒ–æˆåŠŸ (Auth, Firestore)');
return true;
} catch (error) {
console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
alert('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
return false;
}
}

// ============================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
// ============================================

const holidays = {
'2025-01-01': 'å…ƒæ—¥', '2025-01-13': 'æˆäººã®æ—¥', '2025-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥', '2025-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥', '2025-02-24': 'æŒ¯æ›¿ä¼‘æ—¥', '2025-03-20': 'æ˜¥åˆ†ã®æ—¥', '2025-04-29': 'æ˜­å’Œã®æ—¥', '2025-05-03': 'æ†²æ³•è¨˜å¿µæ—¥', '2025-05-04': 'ã¿ã©ã‚Šã®æ—¥', '2025-05-05': 'ã“ã©ã‚‚ã®æ—¥', '2025-05-06': 'æŒ¯æ›¿ä¼‘æ—¥', '2025-07-21': 'æµ·ã®æ—¥', '2025-08-11': 'å±±ã®æ—¥', '2025-09-15': 'æ•¬è€ã®æ—¥', '2025-09-23': 'ç§‹åˆ†ã®æ—¥', '2025-10-13': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥', '2025-11-03': 'æ–‡åŒ–ã®æ—¥', '2025-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥', '2025-11-24': 'æŒ¯æ›¿ä¼‘æ—¥',
'2026-01-01': 'å…ƒæ—¥', '2026-01-12': 'æˆäººã®æ—¥', '2026-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥', '2026-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥', '2026-03-20': 'æ˜¥åˆ†ã®æ—¥', '2026-04-29': 'æ˜­å’Œã®æ—¥', '2026-05-03': 'æ†²æ³•è¨˜å¿µæ—¥', '2026-05-04': 'ã¿ã©ã‚Šã®æ—¥', '2026-05-05': 'ã“ã©ã‚‚ã®æ—¥', '2026-05-06': 'æŒ¯æ›¿ä¼‘æ—¥'
};

let currentUser = null;
let currentMonth = new Date();
let selectedDates = {};
let selectedRequestType = null;
let originalSelectedDates = {};
let staffListForAdmin = [];
let allRequestsForAdmin = {};
let currentScheduleData = null;
let currentEditingDraft = null;
let currentEditingSchedule = null;
// ============================================
// â˜…â˜…â˜… å‹¤å‹™äº¤æ›é–¢é€£ã®é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ â˜…â˜…â˜…
// ============================================
function generateScheduleTableHTML(schedule, monthKey, staff) {
console.log("=== generateScheduleTableHTML é–‹å§‹ ===");
console.log("monthKey:", monthKey);

const parts = monthKey.split("-");
const year = parseInt(parts[0]);
const month = parseInt(parts[1]);
const daysInMonth = new Date(year, month, 0).getDate();

const requestsData = allRequestsForAdmin || {};

let header = '<tr><th style="min-width: 120px;">è·å“¡å</th>';
for (let d = 1; d <= daysInMonth; d++) {
const date = new Date(year, month - 1, d);
const dayOfWeek = date.getDay();
const dateString = year + '-' + String(month).padStart(2, '0') + '-' + String(d).padStart(2, '0');

let headerStyle = '';
if (holidays[dateString]) {
headerStyle = 'background: #FFEBEE; color: #C62828;';
} else if (dayOfWeek === 0) {
headerStyle = 'background: #FFEBEE; color: #C62828;';
} else if (dayOfWeek === 6) {
headerStyle = 'background: #E3F2FD; color: #1565C0;';
}

header += '<th style="' + headerStyle + '">' + d + '</th>';
}
header += '</tr>';

let body = '';
staff.forEach(function(staffMember, index) {
if (staffMember.originalId === 31) return;

const staffSchedule = schedule[staffMember.uid];
if (!staffSchedule) {
console.warn('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + staffMember.name);
return;
}

let nameDisplay = staffMember.name;
if (staffMember.team) {
const teamColor = staffMember.team === 'A' ? '#1976D2' : '#E65100';
nameDisplay += ' <span style="color: ' + teamColor + '; font-weight: bold;">' + staffMember.team + '</span>';
}
if (staffMember.leader) {
nameDisplay += ' <span style="color: #F57C00; font-weight: bold;">L</span>';
}

body += '<tr><td>' + nameDisplay + '</td>';

const staffRequests = requestsData[staffMember.uid];
const staffRequestDates = staffRequests ? staffRequests.dates : {};

for (let d = 1; d <= daysInMonth; d++) {
let shift = staffSchedule.shifts[d] || staffSchedule.shifts[String(d)] || 'ä¼‘';

// â˜…â˜…â˜… ã€Œå¤œã€ã‚’ã€Œæ·±ã€ã«å¤‰æ›ï¼ˆäº’æ›æ€§å¯¾å¿œï¼‰ â˜…â˜…â˜…
if (shift === 'å¤œ') shift = 'æ·±';

const date = new Date(year, month - 1, d);
const dayOfWeek = date.getDay();
const dateString = year + '-' + String(month).padStart(2, '0') + '-' + String(d).padStart(2, '0');

let cellStyle = '';
if (holidays[dateString]) {
cellStyle = 'background: #FFF9F9;';
} else if (dayOfWeek === 0) {
cellStyle = 'background: #FFF9F9;';
} else if (dayOfWeek === 6) {
cellStyle = 'background: #F4F9FF;';
}

// å¤‰æ›´å¾Œ
const requestedShift = staffRequestDates[dateString] || staffRequestDates[String(d)];
// â˜…èµ¤æ æ¡ä»¶: å¸Œæœ›ã¨ç•°ãªã‚‹ ã‹ã¤ å®Ÿéš›ã®ã‚·ãƒ•ãƒˆãŒä¼‘ã¿ç³»ä»¥å¤–ã®å ´åˆã®ã¿
const isRestShift = ['ä¼‘', 'å¹´', 'å‡º', 'ç‰¹', 'AM', 'PM', 'å¤'].includes(shift);
if (requestedShift && requestedShift !== shift && !isRestShift) {
cellStyle += ' border: 3px solid #D32F2F; box-sizing: border-box;';
}

body += '<td class="shift-' + shift + '" style="' + cellStyle + '">' + shift + '</td>';
}
body += '</tr>';
});

let countTable = generateCountTable(schedule, staff, daysInMonth);
let personalCountTable = generatePersonalCountTable(schedule, staff);

return '<table class="schedule-table">' + header + body + '</table>' +
'<h4 style="margin-top: 20px; color: #5D4037;">æ—¥æ¯ã®äººæ•°é›†è¨ˆ</h4>' +
countTable +
'<h4 style="margin-top: 20px; color: #5D4037;">å€‹äººåˆ¥ã‚·ãƒ•ãƒˆå›æ•°é›†è¨ˆ</h4>' +
personalCountTable;
}

function generatePersonalCountTable(schedule, staff) {
let table = '<table class="schedule-table" style="font-size: 11px;">';

table += '<tr>';
table += '<th>è·å“¡å</th>';
table += '<th>ãƒãƒ¼ãƒ </th>';
table += '<th style="background: #E8F5E9;">æ—¥å‹¤</th>';
table += '<th style="background: #E1F5FE;">æº–å¤œ</th>';
table += '<th style="background: #E8EAF6;">æ·±å¤œ</th>';
table += '<th style="background: #FFF3E0;">æº–+æ·±<br>åˆè¨ˆ</th>';
table += '<th style="background: #F5F5F5;">ä¼‘ã¿</th>';
table += '<th style="background: #E3F2FD;">å¹´ä¼‘ç­‰</th>';
table += '<th style="background: #FFEBEE;">åˆè¨ˆ</th>';
table += '</tr>';

const teamAStaff = staff.filter(function(s) {
return s.originalId !== 31 && s.team === 'A';
}).sort(function(a, b) {
return (a.originalId || 0) - (b.originalId || 0);
});

const teamBStaff = staff.filter(function(s) {
return s.originalId !== 31 && s.team === 'B';
}).sort(function(a, b) {
return (a.originalId || 0) - (b.originalId || 0);
});

let teamATotal = { æ—¥: 0, æº–: 0, æ·±: 0, ä¼‘: 0, ãã®ä»–: 0 };

teamAStaff.forEach(function(staffMember) {
const staffSchedule = schedule[staffMember.uid];
if (!staffSchedule) return;

table += generatePersonalCountRow(staffMember, staffSchedule, teamATotal);
});

table += generateSubtotalRow('ãƒãƒ¼ãƒ A å°è¨ˆ', teamATotal, '#E3F2FD');

let teamBTotal = { æ—¥: 0, æº–: 0, æ·±: 0, ä¼‘: 0, ãã®ä»–: 0 };

teamBStaff.forEach(function(staffMember) {
const staffSchedule = schedule[staffMember.uid];
if (!staffSchedule) return;

table += generatePersonalCountRow(staffMember, staffSchedule, teamBTotal);
});

table += generateSubtotalRow('ãƒãƒ¼ãƒ B å°è¨ˆ', teamBTotal, '#FFE0B2');

let grandTotal = {
æ—¥: teamATotal.æ—¥ + teamBTotal.æ—¥,
æº–: teamATotal.æº– + teamBTotal.æº–,
æ·±: teamATotal.æ·± + teamBTotal.æ·±,
ä¼‘: teamATotal.ä¼‘ + teamBTotal.ä¼‘,
ãã®ä»–: teamATotal.ãã®ä»– + teamBTotal.ãã®ä»–
};
table += generateSubtotalRow('å…¨ä½“åˆè¨ˆ', grandTotal, '#E0E0E0', true);

table += '</table>';

return table;
}

function generatePersonalCountRow(staffMember, staffSchedule, teamTotal) {
let row = '<tr>';

let nameDisplay = staffMember.name;
if (staffMember.leader) {
nameDisplay += ' <span style="color: #F57C00; font-weight: bold;">L</span>';
}
row += '<td style="text-align: left; padding-left: 10px;">' + nameDisplay + '</td>';

const teamColor = staffMember.team === 'A' ? '#1976D2' : '#E65100';
row += '<td style="color: ' + teamColor + '; font-weight: bold;">' + staffMember.team + '</td>';

const dayCount = staffSchedule.counts['æ—¥'] || 0;
const eveningCount = staffSchedule.counts['æº–'] || 0;
// â˜…â˜…â˜… ã€Œå¤œã€ã‚‚ã€Œæ·±ã€ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆï¼ˆäº’æ›æ€§å¯¾å¿œï¼‰ â˜…â˜…â˜…
const nightCount = (staffSchedule.counts['æ·±'] || 0) + (staffSchedule.counts['å¤œ'] || 0);
const nightTotal = eveningCount + nightCount;
const restCount = staffSchedule.counts['ä¼‘'] || 0;

const otherCount = (staffSchedule.counts['å¹´'] || 0) +
(staffSchedule.counts['å‡º'] || 0) +
(staffSchedule.counts['ç‰¹'] || 0) +
(staffSchedule.counts['AM'] || 0) +
(staffSchedule.counts['PM'] || 0) +
(staffSchedule.counts['å¤'] || 0);

const total = dayCount + eveningCount + nightCount + restCount + otherCount;

if (teamTotal) {
teamTotal.æ—¥ += dayCount;
teamTotal.æº– += eveningCount;
teamTotal.æ·± += nightCount;
teamTotal.ä¼‘ += restCount;
teamTotal.ãã®ä»– += otherCount;
}

row += '<td style="background: #E8F5E9;">' + dayCount + '</td>';
row += '<td style="background: #E1F5FE;">' + eveningCount + '</td>';
row += '<td style="background: #E8EAF6;">' + nightCount + '</td>';

const nightTotalBg = nightTotal > 8 ? '#FFCDD2' : '#FFF3E0';
row += '<td style="background: ' + nightTotalBg + '; font-weight: bold;">' + nightTotal + '</td>';

row += '<td style="background: #F5F5F5;">' + restCount + '</td>';
row += '<td style="background: #E3F2FD;">' + otherCount + '</td>';
row += '<td style="background: #FFEBEE; font-weight: bold;">' + total + '</td>';

row += '</tr>';
return row;
}

function generateSubtotalRow(label, totals, bgColor, isBold) {
const nightTotal = totals.æº– + totals.æ·±;
const grandTotal = totals.æ—¥ + totals.æº– + totals.æ·± + totals.ä¼‘ + totals.ãã®ä»–;

const fontWeight = isBold ? 'font-weight: bold;' : '';

let row = '<tr>';
row += '<td colspan="2" style="text-align: center; background: ' + bgColor + '; ' + fontWeight + '">' + label + '</td>';
row += '<td style="background: ' + bgColor + '; ' + fontWeight + '">' + totals.æ—¥ + '</td>';
row += '<td style="background: ' + bgColor + '; ' + fontWeight + '">' + totals.æº– + '</td>';
row += '<td style="background: ' + bgColor + '; ' + fontWeight + '">' + totals.æ·± + '</td>';
row += '<td style="background: ' + bgColor + '; ' + fontWeight + '">' + nightTotal + '</td>';
row += '<td style="background: ' + bgColor + '; ' + fontWeight + '">' + totals.ä¼‘ + '</td>';
row += '<td style="background: ' + bgColor + '; ' + fontWeight + '">' + totals.ãã®ä»– + '</td>';
row += '<td style="background: ' + bgColor + '; ' + fontWeight + '">' + grandTotal + '</td>';
row += '</tr>';

return row;
}

function generateCountTable(schedule, staff, daysInMonth) {
const year = currentMonth.getFullYear();
const month = currentMonth.getMonth() + 1;

// â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’ç¢ºèª â˜…â˜…â˜…
console.log("=== generateCountTable ãƒ‡ãƒãƒƒã‚° ===");
console.log("staffæ•°:", staff.length);
console.log("schedule keys:", Object.keys(schedule).slice(0, 3));
if (staff.length > 0 && schedule[staff[0].uid]) {
  console.log("æœ€åˆã®ã‚¹ã‚¿ãƒƒãƒ•UID:", staff[0].uid);
  console.log("æœ€åˆã®ã‚¹ã‚¿ãƒƒãƒ•ã®schedule:", schedule[staff[0].uid]);
  console.log("shifts:", schedule[staff[0].uid].shifts);
  console.log("shifts keys:", Object.keys(schedule[staff[0].uid].shifts || {}).slice(0, 5));
}

const dailyCounts = {};

for (let d = 1; d <= daysInMonth; d++) {
dailyCounts[d] = {
æ—¥: { A: 0, B: 0, total: 0 },
æº–: { A: 0, B: 0, total: 0 },
æ·±: { A: 0, B: 0, total: 0 }
};
}

staff.forEach(function(staffMember) {
if (staffMember.originalId === 31) return;
if (staffMember.originalId === 1) return;
if (staffMember.originalId === 2) return;

const staffSchedule = schedule[staffMember.uid];
if (!staffSchedule) return;

const team = staffMember.team;

for (let d = 1; d <= daysInMonth; d++) {
let shift = staffSchedule.shifts[d] || staffSchedule.shifts[String(d)];

// â˜…â˜…â˜… ã€Œå¤œã€ã‚’ã€Œæ·±ã€ã«å¤‰æ›ï¼ˆäº’æ›æ€§å¯¾å¿œï¼‰ â˜…â˜…â˜…
if (shift === 'å¤œ') shift = 'æ·±';

if (shift === 'æ—¥' || shift === 'æº–' || shift === 'æ·±') {
if (team === 'A' || team === 'B') {
dailyCounts[d][shift][team]++;
dailyCounts[d][shift].total++;
}
}
}
});

let table = '<table class="schedule-table" style="font-size: 10px;">';

table += '<tr>';
table += '<th style="width: 10%; min-width: 80px;">ã‚·ãƒ•ãƒˆ<br>ç¨®åˆ¥</th>';
for (let d = 1; d <= daysInMonth; d++) {
const date = new Date(year, month - 1, d);
const dayOfWeek = date.getDay();
const dateString = year + '-' + String(month).padStart(2, '0') + '-' + String(d).padStart(2, '0');

let headerStyle = 'background: #80CBC4; color: white;';
if (holidays[dateString]) {
headerStyle = 'background: #EF5350; color: white;';
} else if (dayOfWeek === 0) {
headerStyle = 'background: #EF5350; color: white;';
} else if (dayOfWeek === 6) {
headerStyle = 'background: #42A5F5; color: white;';
}

table += '<th style="' + headerStyle + '">' + d + '</th>';
}
table += '</tr>';

// æ—¥å‹¤ A
table += '<tr><td style="background: #E8F5E9; font-weight: bold;">æ—¥å‹¤ A</td>';
for (let d = 1; d <= daysInMonth; d++) {
const count = dailyCounts[d].æ—¥.A;
const bgColor = count === 6 ? '#C8E6C9' : (count < 6 ? '#FFCDD2' : '#FFE082');
table += '<td style="background: ' + bgColor + ';">' + count + '</td>';
}
table += '</tr>';

// æ—¥å‹¤ B
table += '<tr><td style="background: #E8F5E9; font-weight: bold;">æ—¥å‹¤ B</td>';
for (let d = 1; d <= daysInMonth; d++) {
const count = dailyCounts[d].æ—¥.B;
const bgColor = count === 6 ? '#C8E6C9' : (count < 6 ? '#FFCDD2' : '#FFE082');
table += '<td style="background: ' + bgColor + ';">' + count + '</td>';
}
table += '</tr>';

// æ—¥å‹¤ è¨ˆ
table += '<tr><td style="background: #A5D6A7; font-weight: bold;">æ—¥å‹¤ è¨ˆ</td>';
for (let d = 1; d <= daysInMonth; d++) {
const count = dailyCounts[d].æ—¥.total;
const bgColor = count === 12 ? '#C8E6C9' : (count < 12 ? '#FFCDD2' : '#FFE082');
table += '<td style="background: ' + bgColor + '; font-weight: bold;">' + count + '</td>';
}
table += '</tr>';

// æº–å¤œ A
table += '<tr><td style="background: #E1F5FE; font-weight: bold;">æº–å¤œ A</td>';
for (let d = 1; d <= daysInMonth; d++) {
table += '<td>' + dailyCounts[d].æº–.A + '</td>';
}
table += '</tr>';

// æº–å¤œ B
table += '<tr><td style="background: #E1F5FE; font-weight: bold;">æº–å¤œ B</td>';
for (let d = 1; d <= daysInMonth; d++) {
table += '<td>' + dailyCounts[d].æº–.B + '</td>';
}
table += '</tr>';

// æº–å¤œ è¨ˆ
table += '<tr><td style="background: #81D4FA; font-weight: bold;">æº–å¤œ è¨ˆ</td>';
for (let d = 1; d <= daysInMonth; d++) {
const count = dailyCounts[d].æº–.total;
const bgColor = count === 3 ? '#C8E6C9' : (count < 3 ? '#FFCDD2' : '#FFE082');
table += '<td style="background: ' + bgColor + '; font-weight: bold;">' + count + '</td>';
}
table += '</tr>';

// å¤œå‹¤ A
table += '<tr><td style="background: #E8EAF6; font-weight: bold;">æ·±å¤œ A</td>';
for (let d = 1; d <= daysInMonth; d++) {
table += '<td>' + dailyCounts[d].æ·±.A + '</td>';
}
table += '</tr>';

// å¤œå‹¤ B
table += '<tr><td style="background: #E8EAF6; font-weight: bold;">æ·±å¤œ B</td>';
for (let d = 1; d <= daysInMonth; d++) {
table += '<td>' + dailyCounts[d].æ·±.B + '</td>';
}
table += '</tr>';

// å¤œå‹¤ è¨ˆ
table += '<tr><td style="background: #9FA8DA; font-weight: bold;">æ·±å¤œ è¨ˆ</td>';
for (let d = 1; d <= daysInMonth; d++) {
const count = dailyCounts[d].æ·±.total;
const bgColor = count === 3 ? '#C8E6C9' : (count < 3 ? '#FFCDD2' : '#FFE082');
table += '<td style="background: ' + bgColor + '; font-weight: bold;">' + count + '</td>';
}
table += '</tr>';

table += '</table>';

return table;
}

function closeSwapModal() {
document.getElementById('shift-swap-modal').style.display = 'none';
}

function enableShiftSwap(draftKey) {
if (!currentScheduleData || !currentScheduleData.drafts) {
console.error("currentScheduleData ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
return;
}

if (!currentScheduleData.drafts[draftKey]) {
console.error(`draft ${draftKey} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
return;
}

// â˜…é‡è¦: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æœˆæƒ…å ±ã‚’ä½¿ç”¨
if (currentScheduleData.monthKey) {
const [year, month] = currentScheduleData.monthKey.split('-');
currentMonth = new Date(parseInt(year), parseInt(month) - 1, 1);
console.log("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æœˆã‚’è¨­å®š:", currentScheduleData.monthKey);
}

currentEditingDraft = draftKey;
const draft = currentScheduleData.drafts[draftKey];
// â˜…â˜…â˜… ä¿®æ­£: schedule.scheduleã®äºŒé‡æ§‹é€ ã«å¯¾å¿œ â˜…â˜…â˜…
let scheduleToEdit = draft.schedule;
if (draft.schedule && draft.schedule.schedule) {
  scheduleToEdit = draft.schedule.schedule;
}
currentEditingSchedule = JSON.parse(JSON.stringify(scheduleToEdit));

console.log("å‹¤å‹™äº¤æ›ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–:", draftKey);

// â˜…ä¿®æ­£: toISOString()ã‚’ä½¿ã‚ãšã€currentScheduleData.monthKey ã‚’ãã®ã¾ã¾ä½¿ã†ã‹ã€ç¾åœ°æ™‚é–“ã§ç”Ÿæˆ
const year = currentMonth.getFullYear();
const month = String(currentMonth.getMonth() + 1).padStart(2, '0');
const monthKey = `${year}-${month}`;

console.log("ç·¨é›†å¯¾è±¡æœˆ:", monthKey); // â† ã“ã‚Œã§ 2025-12 ã«ãªã‚‹ã¯ãšã§ã™

document.querySelectorAll('.schedule-table td[class^="shift-"]').forEach(cell => {
cell.style.cursor = 'pointer';
cell.removeEventListener('click', handleShiftCellClick);
cell.addEventListener('click', handleShiftCellClick);
});
}
function handleShiftCellClick(event) {
const cell = event.target;
console.log("ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯:", cell);

const row = cell.parentElement;
const colIndex = Array.from(row.children).indexOf(cell);

if (colIndex === 0) {
console.log("åå‰åˆ—ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰");
return;
}

const date = colIndex;
const staffNameCell = row.children[0].textContent.trim();
const staffName = staffNameCell.split(' ')[0];

console.log(`ã‚¯ãƒªãƒƒã‚¯: ${staffName} - ${date}æ—¥`);

const staff = staffListForAdmin.find(s => s.name === staffName);
if (!staff) {
console.error("ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", staffName);
showMessage("ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + staffName, 'error');
return;
}

const currentShift = currentEditingSchedule[staff.uid].shifts[date];
console.log(`ç¾åœ¨ã®ã‚·ãƒ•ãƒˆ: ${currentShift}`);

showSwapModal(staff, date, currentShift);
}

// ============================================
// â˜…ä¿®æ­£ç‰ˆâ˜… ã‚·ãƒ•ãƒˆå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…¨ã‚·ãƒ•ãƒˆé¸æŠå¯èƒ½ï¼‰
// ============================================

function showSwapModal(staff, date, currentShift) {
const modal = document.getElementById('shift-swap-modal');
const content = document.getElementById('swap-modal-content');

const year = currentMonth.getFullYear();
const month = currentMonth.getMonth() + 1;
const monthKey = `${year}-${String(month).padStart(2, '0')}`;
const dateObj = new Date(year, month - 1, date);
const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dateObj.getDay()];

// å¸Œæœ›æƒ…å ±ã‚’å–å¾—
const requestsData = allRequestsForAdmin || {};
const staffRequests = requestsData[staff.uid];
const staffRequestDates = staffRequests && staffRequests.dates ? staffRequests.dates : {};
const dateString = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
const requestedShift = staffRequestDates[dateString] || staffRequestDates[String(date)] || null;

let requestInfo = '';
if (requestedShift) {
requestInfo = `<p style="margin: 5px 0 0 0; color: #D32F2F;">
å¸Œæœ›: <span style="padding: 4px 8px; border-radius: 4px; font-weight: bold; background: #FFEBEE;">${requestedShift}</span>
</p>`;
}

content.innerHTML = `
<div style="background: #F5F5F5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
<h4 style="margin: 0 0 10px 0; color: #5D4037;">å¤‰æ›´å¯¾è±¡</h4>
<p style="margin: 0; font-size: 16px;">
<strong>${staff.name}</strong> ${staff.team}ãƒãƒ¼ãƒ  -
<strong>${month}æœˆ${date}æ—¥ (${dayOfWeek})</strong>
</p>
<p style="margin: 5px 0 0 0; color: #666;">
ç¾åœ¨: <span class="shift-${currentShift}" style="padding: 4px 8px; border-radius: 4px; font-weight: bold;">${currentShift}</span>
</p>
${requestInfo}
</div>

<!-- â˜…â˜…â˜… ç›´æ¥ã‚·ãƒ•ãƒˆå¤‰æ›´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â˜…â˜…â˜… -->
<h4 style="color: #5D4037; margin-bottom: 15px;">ã‚·ãƒ•ãƒˆã‚’ç›´æ¥å¤‰æ›´</h4>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
<button class="shift-select-btn ${currentShift === 'æ—¥' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'æ—¥')"
style="padding: 12px; border: 2px solid #4CAF50; border-radius: 8px; background: ${currentShift === 'æ—¥' ? '#E8F5E9' : 'white'}; color: #388E3C; font-weight: bold; cursor: pointer;">
æ—¥å‹¤
</button>
<button class="shift-select-btn ${currentShift === 'æº–' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'æº–')"
style="padding: 12px; border: 2px solid #03A9F4; border-radius: 8px; background: ${currentShift === 'æº–' ? '#E1F5FE' : 'white'}; color: #0277BD; font-weight: bold; cursor: pointer;">
æº–å¤œ
</button>
<button class="shift-select-btn ${currentShift === 'æ·±' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'æ·±')"
style="padding: 12px; border: 2px solid #3F51B5; border-radius: 8px; background: ${currentShift === 'æ·±' ? '#E8EAF6' : 'white'}; color: #303F9F; font-weight: bold; cursor: pointer;">
æ·±å¤œ
</button>
<button class="shift-select-btn ${currentShift === 'ä¼‘' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'ä¼‘')"
style="padding: 12px; border: 2px solid #9E9E9E; border-radius: 8px; background: ${currentShift === 'ä¼‘' ? '#F5F5F5' : 'white'}; color: #616161; font-weight: bold; cursor: pointer;">
ä¼‘ã¿
</button>
</div>

<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
<button class="shift-select-btn ${currentShift === 'å¹´' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'å¹´')"
style="padding: 10px; border: 2px solid #42A5F5; border-radius: 8px; background: ${currentShift === 'å¹´' ? '#E3F2FD' : 'white'}; color: #1976D2; font-weight: bold; cursor: pointer; font-size: 12px;">
å¹´ä¼‘
</button>
<button class="shift-select-btn ${currentShift === 'å¤' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'å¤')"
style="padding: 10px; border: 2px solid #FF9800; border-radius: 8px; background: ${currentShift === 'å¤' ? '#FFF3E0' : 'white'}; color: #F57C00; font-weight: bold; cursor: pointer; font-size: 12px;">
å¤ä¼‘
</button>
<button class="shift-select-btn ${currentShift === 'ç‰¹' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'ç‰¹')"
style="padding: 10px; border: 2px solid #9575CD; border-radius: 8px; background: ${currentShift === 'ç‰¹' ? '#F3E5F5' : 'white'}; color: #7B1FA2; font-weight: bold; cursor: pointer; font-size: 12px;">
ç‰¹ä¼‘
</button>
<button class="shift-select-btn ${currentShift === 'å‡º' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'å‡º')"
style="padding: 10px; border: 2px solid #FFA726; border-radius: 8px; background: ${currentShift === 'å‡º' ? '#FFF8E1' : 'white'}; color: #EF6C00; font-weight: bold; cursor: pointer; font-size: 12px;">
å‡ºå¼µ
</button>
<button class="shift-select-btn ${currentShift === 'AM' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'AM')"
style="padding: 10px; border: 2px solid #03A9F4; border-radius: 8px; background: ${currentShift === 'AM' ? '#E1F5FE' : 'white'}; color: #0288D1; font-weight: bold; cursor: pointer; font-size: 12px;">
AMä¼‘
</button>
<button class="shift-select-btn ${currentShift === 'PM' ? 'active' : ''}"
onclick="directShiftChange('${staff.uid}', ${date}, 'PM')"
style="padding: 10px; border: 2px solid #3F51B5; border-radius: 8px; background: ${currentShift === 'PM' ? '#E8EAF6' : 'white'}; color: #303F9F; font-weight: bold; cursor: pointer; font-size: 12px;">
PMä¼‘
</button>
</div>

<hr style="margin: 20px 0; border: none; border-top: 1px solid #E0E0E0;">

<h4 style="color: #5D4037; margin-bottom: 15px;">ä»–ã‚¹ã‚¿ãƒƒãƒ•ã¨äº¤æ›ãƒ»è­²æ¸¡</h4>
<div id="candidate-list">
${generateCandidateList(staff, date, currentShift)}
</div>
`;

modal.style.display = 'block';
}

// ============================================
// â˜…æ–°è¦â˜… ç›´æ¥ã‚·ãƒ•ãƒˆå¤‰æ›´
// ============================================
async function directShiftChange(staffUid, date, newShift) {
console.log(`ç›´æ¥å¤‰æ›´: ${staffUid} - ${date}æ—¥ â†’ ${newShift}`);

if (!currentEditingSchedule || !currentEditingSchedule[staffUid]) {
console.error("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™");
showMessage("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", 'error');
return;
}

const staff = staffListForAdmin.find(s => s.uid === staffUid);
if (!staff) {
console.error("ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", staffUid);
return;
}

const oldShift = currentEditingSchedule[staffUid].shifts[date];

if (oldShift === newShift) {
showMessage("åŒã˜ã‚·ãƒ•ãƒˆã§ã™", 'info');
return;
}

// ã‚·ãƒ•ãƒˆã‚’å¤‰æ›´
currentEditingSchedule[staffUid].shifts[date] = newShift;

// ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
if (oldShift && currentEditingSchedule[staffUid].counts[oldShift] > 0) {
currentEditingSchedule[staffUid].counts[oldShift]--;
}
if (!currentEditingSchedule[staffUid].counts[newShift]) {
currentEditingSchedule[staffUid].counts[newShift] = 0;
}
currentEditingSchedule[staffUid].counts[newShift]++;

console.log(`å¤‰æ›´å®Œäº†: ${staff.name} ${date}æ—¥ ${oldShift} â†’ ${newShift}`);
showMessage(`${staff.name}ã®${date}æ—¥ã‚’ ${oldShift} â†’ ${newShift} ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');

closeSwapModal();

// ä¿å­˜ã—ã¦ã‹ã‚‰ç”»é¢ã‚’æ›´æ–°
await saveEditedSchedule();
await new Promise(resolve => setTimeout(resolve, 500));

// currentScheduleDataã‚’æ›´æ–°
if (currentScheduleData && currentScheduleData.drafts && currentScheduleData.drafts[currentEditingDraft]) {
currentScheduleData.drafts[currentEditingDraft].schedule = currentEditingSchedule;
}

refreshScheduleDisplay();
}
function generateCandidateList(targetStaff, date, targetShift) {
const candidates = staffListForAdmin.filter(s =>
s.originalId !== 31 &&
s.uid !== targetStaff.uid &&
s.originalId !== 1 &&
s.originalId !== 2
);

let html = '';

candidates.forEach(candidate => {
const candidateShift = currentEditingSchedule[candidate.uid].shifts[date];
const constraints = checkSwapConstraints(targetStaff, candidate, date, targetShift, candidateShift);

const isAvailable = constraints.canExchange || constraints.canTransfer;
const availableClass = isAvailable ? '' : 'unavailable';

html += `
<div class="swap-candidate ${availableClass}">
<div class="candidate-info">
<div class="candidate-name">
${candidate.name}
<span style="color: ${candidate.team === 'A' ? '#1976D2' : '#E65100'};">${candidate.team}</span>
${candidate.leader ? '<span style="color: #F57C00;">L</span>' : ''}
</div>
<div class="candidate-status">
ç¾åœ¨: <span class="shift-${candidateShift}">${candidateShift}</span>
${constraints.warning ? `<br><span style="color: #D32F2F;">âš  ${constraints.warning}</span>` : ''}
</div>
</div>
<div class="swap-actions">
${constraints.canExchange ? `
<button class="swap-btn exchange" onclick="executeSwap('${targetStaff.uid}', '${candidate.uid}', ${date}, 'exchange')">
äº¤æ›
</button>
` : ''}
${constraints.canTransfer ? `
<button class="swap-btn transfer" onclick="executeSwap('${targetStaff.uid}', '${candidate.uid}', ${date}, 'transfer')">
è­²æ¸¡
</button>
` : ''}
</div>
</div>
`;
});

if (html === '') {
html = '<p style="color: #666; text-align: center; padding: 20px;">äº¤æ›ãƒ»è­²æ¸¡å¯èƒ½ãªã‚¹ã‚¿ãƒƒãƒ•ãŒã„ã¾ã›ã‚“</p>';
}

return html;
}

function checkSwapConstraints(staffA, staffB, date, shiftA, shiftB) {
const result = {
canExchange: false,
canTransfer: false,
warning: null
};

result.canTransfer = true;

if (shiftB && shiftB !== 'ä¼‘') {
result.canExchange = true;

const staffANightCount = currentEditingSchedule[staffA.uid].counts['æº–'] +
currentEditingSchedule[staffA.uid].counts['æ·±'];
const staffBNightCount = currentEditingSchedule[staffB.uid].counts['æº–'] +
currentEditingSchedule[staffB.uid].counts['æ·±'];

const shiftAIsNight = (shiftA === 'æº–' || shiftA === 'æ·±');
const shiftBIsNight = (shiftB === 'æº–' || shiftB === 'æ·±');

if (shiftAIsNight && !shiftBIsNight && staffBNightCount >= 8) {
result.canExchange = false;
result.warning = "æ·±å¤œå›æ•°ä¸Šé™è¶…é";
}

if (!shiftAIsNight && shiftBIsNight && staffANightCount >= 8) {
result.canExchange = false;
result.warning = "æ·±å¤œå›æ•°ä¸Šé™è¶…é";
}
}

return result;
}

// ============================================
// â˜…ä¿®æ­£ç‰ˆâ˜… å‹¤å‹™äº¤æ›å®Ÿè¡Œ
// ============================================
async function executeSwap(staffAUid, staffBUid, date, mode) {
console.log(`${mode}: ${staffAUid} â‡” ${staffBUid} (${date}æ—¥)`);

if (!currentEditingSchedule || !currentEditingSchedule[staffAUid] || !currentEditingSchedule[staffBUid]) {
console.error("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™");
showMessage("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", 'error');
return;
}

const staffA = staffListForAdmin.find(s => s.uid === staffAUid);
const staffB = staffListForAdmin.find(s => s.uid === staffBUid);

if (!staffA || !staffB) {
console.error("ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", staffAUid, staffBUid);
showMessage("ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", 'error');
return;
}

const shiftA = currentEditingSchedule[staffAUid].shifts[date];
const shiftB = currentEditingSchedule[staffBUid].shifts[date];

console.log(`å¤‰æ›´å‰: ${staffA.name}=${shiftA}, ${staffB.name}=${shiftB}`);

if (mode === 'exchange') {
// äº¤æ›
currentEditingSchedule[staffAUid].shifts[date] = shiftB;
currentEditingSchedule[staffBUid].shifts[date] = shiftA;

// ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
if (currentEditingSchedule[staffAUid].counts[shiftA] > 0) {
currentEditingSchedule[staffAUid].counts[shiftA]--;
}
if (!currentEditingSchedule[staffAUid].counts[shiftB]) {
currentEditingSchedule[staffAUid].counts[shiftB] = 0;
}
currentEditingSchedule[staffAUid].counts[shiftB]++;

if (currentEditingSchedule[staffBUid].counts[shiftB] > 0) {
currentEditingSchedule[staffBUid].counts[shiftB]--;
}
if (!currentEditingSchedule[staffBUid].counts[shiftA]) {
currentEditingSchedule[staffBUid].counts[shiftA] = 0;
}
currentEditingSchedule[staffBUid].counts[shiftA]++;

showMessage(`${staffA.name} ã¨ ${staffB.name} ã® ${date}æ—¥ã®ã‚·ãƒ•ãƒˆã‚’äº¤æ›ã—ã¾ã—ãŸ`, 'success');

} else if (mode === 'transfer') {
// è­²æ¸¡
currentEditingSchedule[staffBUid].shifts[date] = shiftA;
currentEditingSchedule[staffAUid].shifts[date] = 'ä¼‘';

// ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
if (shiftB && shiftB !== 'ä¼‘' && currentEditingSchedule[staffBUid].counts[shiftB] > 0) {
currentEditingSchedule[staffBUid].counts[shiftB]--;
}
if (!currentEditingSchedule[staffBUid].counts[shiftA]) {
currentEditingSchedule[staffBUid].counts[shiftA] = 0;
}
currentEditingSchedule[staffBUid].counts[shiftA]++;

if (currentEditingSchedule[staffAUid].counts[shiftA] > 0) {
currentEditingSchedule[staffAUid].counts[shiftA]--;
}
if (!currentEditingSchedule[staffAUid].counts['ä¼‘']) {
currentEditingSchedule[staffAUid].counts['ä¼‘'] = 0;
}
currentEditingSchedule[staffAUid].counts['ä¼‘']++;

showMessage(`${staffA.name} ã® ${date}æ—¥ã®ã‚·ãƒ•ãƒˆã‚’ ${staffB.name} ã«è­²æ¸¡ã—ã¾ã—ãŸ`, 'success');
}

console.log(`å¤‰æ›´å¾Œ: ${staffA.name}=${currentEditingSchedule[staffAUid].shifts[date]}, ${staffB.name}=${currentEditingSchedule[staffBUid].shifts[date]}`);

closeSwapModal();

// â˜…é‡è¦: ä¿å­˜ã—ã¦ã‹ã‚‰ç”»é¢ã‚’æ›´æ–°
await saveEditedSchedule();

// â˜…å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ›´æ–°ï¼ˆFirestoreã®æ›¸ãè¾¼ã¿å®Œäº†ã‚’å¾…ã¤ï¼‰
await new Promise(resolve => setTimeout(resolve, 500));

// â˜…ä¿®æ­£: currentScheduleDataã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å†æç”»
if (currentScheduleData && currentScheduleData.drafts && currentScheduleData.drafts[currentEditingDraft]) {
currentScheduleData.drafts[currentEditingDraft].schedule = currentEditingSchedule;
}

refreshScheduleDisplay();
}

// ============================================
// â˜…ä¿®æ­£ç‰ˆâ˜… ç”»é¢å†æç”»
// ============================================
// ============================================
// â˜…ä¿®æ­£ç‰ˆâ˜… ã‚¹ã‚³ã‚¢å†è¨ˆç®—ã¨èµ¤æ æ›´æ–°æ©Ÿèƒ½
// ============================================

// ã‚¹ã‚³ã‚¢è¨ˆç®—é–¢æ•°
// ============================================
// â˜…ä¿®æ­£ç‰ˆâ˜… ã‚¹ã‚³ã‚¢å†è¨ˆç®—ï¼ˆèµ¤æ ã¨åŒã˜æ¡ä»¶ï¼‰
// ============================================
function calculateScheduleScore(schedule, requestsData, staffList) {
let score = 0;
let fulfilled = 0;
let unfulfilled = 0;

const WEIGHTS = {
REQUEST_WEIGHT: 2,
WORK_FAIRNESS: 1,
NIGHT_FAIRNESS: 1,
PATTERN_BONUS: 3
};

const workCounts = [];
const nightCounts = [];

staffList.forEach(function(staff) {
if (staff.originalId === 31) return;
if (staff.originalId === 1 || staff.originalId === 2) return;
if (staff.weekdayDayOnly) return;

const staffSchedule = schedule[staff.uid];
if (!staffSchedule) return;

let workCount = 0;
let nightCount = 0;

Object.values(staffSchedule.shifts).forEach(function(shift) {
if (!['ä¼‘', 'å¹´', 'å‡º', 'ç‰¹', 'AM', 'PM', 'å¤'].includes(shift)) {
workCount++;
}
if (shift === 'æº–' || shift === 'æ·±') {
nightCount++;
}
});

workCounts.push(workCount);
nightCounts.push(nightCount);

// å¸Œæœ›ãƒã‚§ãƒƒã‚¯ï¼ˆä¼‘ãƒ»æ—¥ã®ã¿ã‚¹ã‚³ã‚¢ã«å½±éŸ¿ï¼‰
const staffRequests = requestsData[staff.uid];
if (staffRequests && staffRequests.dates) {
Object.keys(staffRequests.dates).forEach(function(dateKey) {
const requestType = staffRequests.dates[dateKey];

if (requestType === 'ä¼‘' || requestType === 'æ—¥') {
const day = dateKey.includes('-') ? parseInt(dateKey.split('-')[2]) : parseInt(dateKey);
const actualShift = staffSchedule.shifts[day] || staffSchedule.shifts[String(day)];

if (requestType === 'ä¼‘') {
if (['ä¼‘', 'å¹´', 'å‡º', 'ç‰¹', 'AM', 'PM', 'å¤'].includes(actualShift)) {
score += WEIGHTS.REQUEST_WEIGHT;
fulfilled++;
} else {
unfulfilled++;
}
} else if (requestType === 'æ—¥') {
if (actualShift === 'æ—¥') {
score += WEIGHTS.REQUEST_WEIGHT;
fulfilled++;
} else {
// â˜…ä¼‘ã¿ç³»ãªã‚‰æœªå……è¶³ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
if (!['ä¼‘', 'å¹´', 'å‡º', 'ç‰¹', 'AM', 'PM', 'å¤'].includes(actualShift)) {
unfulfilled++;
}
}
}
}
});
}
});

// å‹¤å‹™æ—¥æ•°å…¬å¹³æ€§
if (workCounts.length > 0) {
const avgWork = 20;
workCounts.forEach(function(wc) {
score -= Math.abs(wc - avgWork) * WEIGHTS.WORK_FAIRNESS;
});
}

// æ·±å¤œå›æ•°å…¬å¹³æ€§
if (nightCounts.length > 0) {
const avgNight = 6;
nightCounts.forEach(function(nc) {
score -= Math.abs(nc - avgNight) * WEIGHTS.NIGHT_FAIRNESS;
});
}

return {
score: score,
fulfilled: fulfilled,
unfulfilled: unfulfilled
};
}

// ============================================
// â˜…ä¿®æ­£ç‰ˆâ˜… ç”»é¢å†æç”»ï¼ˆã‚¹ã‚³ã‚¢æ›´æ–°ä»˜ãï¼‰
// ============================================
function refreshScheduleDisplay() {
const year = currentMonth.getFullYear();
const month = String(currentMonth.getMonth() + 1).padStart(2, '0');
const monthKey = `${year}-${month}`;

console.log("=== refreshScheduleDisplay é–‹å§‹ ===");
console.log("monthKey:", monthKey);
console.log("currentEditingDraft:", currentEditingDraft);

if (!currentScheduleData || !currentScheduleData.drafts) {
console.error("currentScheduleData ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
return;
}

const draft = currentScheduleData.drafts[currentEditingDraft];
if (!draft) {
console.error('draft ' + currentEditingDraft + ' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
return;
}

// â˜…é‡è¦: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
draft.schedule = currentEditingSchedule;

// â˜…â˜…â˜… ã‚¹ã‚³ã‚¢ã‚’å†è¨ˆç®— â˜…â˜…â˜…
const requestsData = allRequestsForAdmin || {};
const scoreResult = calculateScheduleScore(currentEditingSchedule, requestsData, staffListForAdmin);
draft.score = scoreResult.score;

console.log("ã‚¹ã‚³ã‚¢å†è¨ˆç®—:", scoreResult);

// â˜…è¡¨å…¨ä½“ã‚’å†æç”»
const resultsArea = document.getElementById('schedule-results');
if (!resultsArea) {
console.error("schedule-results ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
return;
}

// â˜…æ—¢å­˜ã®è¡¨ã‚’å‰Šé™¤ï¼ˆå®Œå…¨ã‚¯ãƒªã‚¢ï¼‰
resultsArea.innerHTML = '';

// â˜…ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆã‚¹ã‚³ã‚¢è¡¨ç¤ºä»˜ãï¼‰
let statusHtml = '<div style="background: #E8F5E9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
statusHtml += '<h4 style="color: #2E7D32;"><i class="fas fa-check-circle"></i> OR-Toolsæœ€é©åŒ–';
statusHtml += ' (ã‚¹ã‚³ã‚¢: <span id="current-score">' + scoreResult.score + '</span>)</h4>';
statusHtml += '<p style="font-size: 13px; color: #555;">';
statusHtml += 'å¸Œæœ›å……è¶³: ' + scoreResult.fulfilled + 'ä»¶ / æœªå……è¶³: ' + scoreResult.unfulfilled + 'ä»¶';
if (draft.elapsedTime) {
statusHtml += ' / è¨ˆç®—æ™‚é–“: ' + parseFloat(draft.elapsedTime).toFixed(2) + 'ç§’';
}
statusHtml += '</p>';
statusHtml += '</div>';

resultsArea.innerHTML = statusHtml;

// â˜…æ–°ã—ã„è¡¨ã‚’ç”Ÿæˆ
const warningCount = draft.validation && draft.validation.warnings ? draft.validation.warnings.length : 0;
const validationStatus = warningCount === 0
? '<span style="color: #2E7D32;">âœ“ ã™ã¹ã¦ã®å¿…é ˆæ¡ä»¶ã‚’ã‚¯ãƒªã‚¢</span>'
: '<span style="color: #F57C00;">âš  è­¦å‘Š ' + warningCount + 'ä»¶</span>';

const draftDiv = document.createElement('div');
draftDiv.style = "margin-top: 20px; border: 1px solid #E0E0E0; border-radius: 8px; overflow: hidden;";

// ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
let attemptsInfo = '';
if (draft.attempts) {
attemptsInfo = '<span style="font-size: 13px; color: #666;">(' +
draft.attempts + 'å›è©¦è¡Œ)</span>';
}

draftDiv.innerHTML =
'<div style="background: #F8F8F8; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;">' +
'<h4 style="color: #5D4037;">' + (draft.type || 'å‹¤å‹™è¡¨') + ' ' + attemptsInfo + '</h4>' +
'<div>' + validationStatus + '</div>' +
'</div>';

// è­¦å‘Šè¡¨ç¤º
if (warningCount > 0) {
const warningDiv = document.createElement('div');
warningDiv.style = "padding: 10px 15px; background: #FFF3E0; border-left: 4px solid #F57C00;";

let warningsHtml = '<ul style="margin: 5px 0 0 20px; color: #E65100;">';
const maxWarnings = Math.min(10, draft.validation.warnings.length);
for (let i = 0; i < maxWarnings; i++) {
warningsHtml += '<li>' + draft.validation.warnings[i] + '</li>';
}
if (warningCount > 10) {
warningsHtml += '<li>... ä»– ' + (warningCount - 10) + ' ä»¶</li>';
}
warningsHtml += '</ul>';

warningDiv.innerHTML = '<strong style="color: #E65100;">è­¦å‘Šäº‹é …:</strong>' + warningsHtml;
draftDiv.appendChild(warningDiv);
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨
const scheduleDiv = document.createElement('div');
scheduleDiv.style = "padding: 15px; overflow-x: auto;";

// â˜…ç¢ºå®šæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
const isConfirmed = draft.confirmed === true;
const confirmButtonHTML = isConfirmed
? '<button id="confirm-draft1" disabled style="background: #4CAF50; margin-top: 15px; width: auto; padding: 8px 15px; font-size: 14px; cursor: not-allowed;">' +
'<i class="fas fa-check-circle"></i> ç¢ºå®šæ¸ˆã¿ ' + (draft.confirmedBy ? '(' + draft.confirmedBy + ')' : '') +
'</button>'
: '<button id="confirm-draft1" style="background: #1976D2; margin-top: 15px; width: auto; padding: 8px 15px; font-size: 14px;">' +
'<i class="fas fa-check"></i> ã“ã®æ¡ˆã§ç¢ºå®šã™ã‚‹' +
'</button>';

scheduleDiv.innerHTML = generateScheduleTableHTML(currentEditingSchedule, monthKey, staffListForAdmin) + confirmButtonHTML;

draftDiv.appendChild(scheduleDiv);
resultsArea.appendChild(draftDiv);

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
if (!isConfirmed) {
const confirmBtn = document.getElementById('confirm-draft1');
if (confirmBtn) {
confirmBtn.addEventListener('click', function() {
confirmSchedule('draft1');
});
}
}

// å‹¤å‹™äº¤æ›ãƒ¢ãƒ¼ãƒ‰ã‚’å†æœ‰åŠ¹åŒ–
enableShiftSwap('draft1');

console.log("âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ã‚’å†æç”»ã—ã¾ã—ãŸï¼ˆã‚¹ã‚³ã‚¢: " + scoreResult.score + "ï¼‰");
}
async function saveEditedSchedule() {
try {
const monthKey = currentMonth.toISOString().slice(0, 7);

console.log("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜é–‹å§‹:", monthKey, currentEditingDraft);

// â˜…æ”¹è‰¯: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆï¼‰
const scheduleRef = firestore.collection('Schedules').doc(monthKey);
const scheduleDoc = await scheduleRef.get();

let currentData;

if (!scheduleDoc.exists) {
console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚æ–°è¦ä½œæˆã—ã¾ã™");
// æ–°è¦ä½œæˆ
currentData = {
monthKey: monthKey,
createdAt: firebase.firestore.FieldValue.serverTimestamp(),
drafts: {}
};
} else {
currentData = scheduleDoc.data();
}

// â˜…draftså…¨ä½“ã‚’æ›´æ–°
if (!currentData.drafts) {
currentData.drafts = {};
}

if (!currentData.drafts[currentEditingDraft]) {
console.log(`draft ${currentEditingDraft} ã‚’æ–°è¦ä½œæˆã—ã¾ã™`);
currentData.drafts[currentEditingDraft] = {
type: 'æ‰‹å‹•ç·¨é›†ç‰ˆ',
attempts: 1,
schedule: {},
validation: {
criticalErrors: [],
warnings: []
}
};
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–°
currentData.drafts[currentEditingDraft].schedule = currentEditingSchedule;
currentData.drafts[currentEditingDraft].lastModified = firebase.firestore.FieldValue.serverTimestamp();

// å…¨ä½“ã‚’ä¿å­˜
await scheduleRef.set(currentData, { merge: true });

console.log("âœ… ç·¨é›†ã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ");

} catch (error) {
console.error("âŒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
console.error("ã‚¨ãƒ©ãƒ¼è©³ç´°:", error.stack);
showMessage("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'error');
}
}

function showMessage(message, type) {
const color = type === 'success' ? '#4CAF50' : '#D32F2F';
const icon = type === 'success' ? 'âœ“' : 'âœ—';

const messageDiv = document.createElement('div');
messageDiv.style.cssText = `
position: fixed;
top: 20px;
right: 20px;
background: ${color};
color: white;
padding: 15px 20px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
z-index: 10000;
font-size: 14px;
max-width: 400px;
animation: slideIn 0.3s ease-out;
`;
messageDiv.innerHTML = `<strong>${icon}</strong> ${message}`;
document.body.appendChild(messageDiv);

setTimeout(() => {
messageDiv.style.animation = 'slideOut 0.3s ease-out';
setTimeout(() => {
messageDiv.remove();
}, 300);
}, 3000);
}

// ============================================
// â˜…æ–°è¦â˜… ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å®‰å…¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
// ============================================
function formatTimestamp(timestamp) {
if (!timestamp) {
return 'æ—¥æ™‚ä¸æ˜';
}

try {
let date;

// Firestore Timestampã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
if (timestamp.toDate && typeof timestamp.toDate === 'function') {
date = timestamp.toDate();
}
// ISOæ–‡å­—åˆ—ã®å ´åˆ
else if (typeof timestamp === 'string') {
date = new Date(timestamp);
}
// Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
else if (timestamp instanceof Date) {
date = timestamp;
}
// ãƒŸãƒªç§’æ•°å€¤ã®å ´åˆ
else if (typeof timestamp === 'number') {
date = new Date(timestamp);
}
// ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼ˆseconds, nanosecondsï¼‰
else if (timestamp.seconds) {
date = new Date(timestamp.seconds * 1000);
}
else {
return 'æ—¥æ™‚ä¸æ˜';
}

return date.toLocaleString('ja-JP');

} catch (error) {
console.error('ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error, timestamp);
return 'æ—¥æ™‚ä¸æ˜';
}
}
// ============================================
// ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£
// ============================================
// ============================================
// ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£
// ============================================

async function login() {
const userId = document.getElementById('userId').value;
const password = document.getElementById('password').value;
const loginButton = document.getElementById('loginButton');

const email = `${userId}@7w.com`;

loginButton.disabled = true;
loginButton.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';

try {
const userCredential = await auth.signInWithEmailAndPassword(email, password);
const user = userCredential.user;

const staffDoc = await firestore.collection('staff').doc(user.uid).get({ source: 'server' });

if (!staffDoc.exists) {
throw new Error('è·å“¡åç°¿ã«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
}

currentUser = {
uid: user.uid,
...staffDoc.data()
};

if (currentUser.passwordChanged === false) {
showChangePasswordSection();
} else {
showMainSection();
}

} catch (error) {
console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
document.getElementById('loginError').textContent = 'IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
} else {
document.getElementById('loginError').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
}
} finally {
loginButton.disabled = false;
loginButton.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
}
}

function showChangePasswordForm() {
document.getElementById('mainSection').classList.add('hidden');
document.getElementById('adminSection').classList.add('hidden');
document.getElementById('loginSection').classList.add('hidden');

document.getElementById('newPassword').value = '';
document.getElementById('confirmPassword').value = '';
document.getElementById('passwordError').textContent = '';

const titleElement = document.querySelector('#changePasswordSection h2');
if (currentUser && currentUser.passwordChanged) {
titleElement.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´';
} else {
titleElement.textContent = 'åˆå›ãƒ­ã‚°ã‚¤ãƒ³ - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´';
}

document.getElementById('changePasswordSection').classList.remove('hidden');
}

async function changePassword() {
const newPassword = document.getElementById('newPassword').value;
const confirmPassword = document.getElementById('confirmPassword').value;

if (!/^\d{6}$/.test(newPassword)) {
document.getElementById('passwordError').textContent = '6æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
return;
}
if (newPassword !== confirmPassword) {
document.getElementById('passwordError').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“';
return;
}

try {
const user = auth.currentUser;
if (!user) {
throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“');
}

await user.updatePassword(newPassword);

await firestore.collection('staff').doc(user.uid).update({
passwordChanged: true
});

alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚');

currentUser.passwordChanged = true;

showMainSection();

} catch (error) {
console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
document.getElementById('passwordError').textContent = 'å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ' + error.message;
}
}

function hasUnsavedChanges() {
if (!currentUser) return false;

if (Object.keys(selectedDates).length !== Object.keys(originalSelectedDates).length) {
return true;
}
for (const date in selectedDates) {
if (selectedDates[date] !== originalSelectedDates[date]) {
return true;
}
}
return false;
}

async function logout() {
if (hasUnsavedChanges()) {
if (!confirm('å¤‰æ›´ã•ã‚ŒãŸå¸Œæœ›ãŒæå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nä¿å­˜ã›ãšã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
return;
}
}

try {
await auth.signOut();
} catch (error) {
console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
}

currentUser = null;
selectedDates = {};
originalSelectedDates = {};
selectedRequestType = null;

document.getElementById('userId').value = '';
document.getElementById('password').value = '';
document.getElementById('loginError').textContent = '';

document.getElementById('loginSection').classList.remove('hidden');
document.getElementById('mainSection').classList.add('hidden');
document.getElementById('adminSection').classList.add('hidden');
document.getElementById('changePasswordSection').classList.add('hidden');
}

// ============================================
// ç”»é¢è¡¨ç¤º
// ============================================

function showChangePasswordSection() {
document.getElementById('loginSection').classList.add('hidden');
document.getElementById('changePasswordSection').classList.remove('hidden');
}

async function showMainSection() {
document.getElementById('loginSection').classList.add('hidden');
document.getElementById('changePasswordSection').classList.add('hidden');
document.getElementById('adminSection').classList.add('hidden');
document.getElementById('mainSection').classList.remove('hidden');

document.getElementById('welcomeMessage').textContent = currentUser.name + 'ã•ã‚“ã€ãŠç–²ã‚Œæ§˜ã§ã™ï¼';

if (currentUser.isAdmin === true) {
document.getElementById('adminButton').classList.remove('hidden');
} else {
document.getElementById('adminButton').classList.add('hidden');
}

setTargetMonth();
startCountdown();

await loadUserRequests();
renderCalendar();
await updateSubmissionStatus();
}

async function showAdminSection() {
document.getElementById('loginSection').classList.add('hidden');
document.getElementById('mainSection').classList.add('hidden');
document.getElementById('adminSection').classList.remove('hidden');

currentMonth = new Date();

await renderAdminTable();
}

// ============================================
// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£
// ============================================

function setTargetMonth() {
const now = new Date();
const currentMonthDeadline = new Date(now.getFullYear(), now.getMonth(), 7, 9, 0, 0);

if (now <= currentMonthDeadline) {
currentMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
} else {
currentMonth = new Date(now.getFullYear(), now.getMonth() + 2, 1);
}
}

function renderCalendar() {
const year = currentMonth.getFullYear();
const month = currentMonth.getMonth();

document.getElementById('currentMonth').textContent = year + 'å¹´' + (month + 1) + 'æœˆ';

const calendarElement = document.getElementById('calendar');
calendarElement.innerHTML = '';

const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
weekdays.forEach((day, index) => {
const header = document.createElement('div');
header.className = 'weekday-header';
if (index === 0) header.className += ' sunday';
if (index === 6) header.className += ' saturday';
header.textContent = day;
calendarElement.appendChild(header);
});

const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const startDay = firstDay.getDay();

for (let i = 0; i < startDay; i++) {
const emptyDay = document.createElement('div');
emptyDay.className = 'calendar-day empty';
calendarElement.appendChild(emptyDay);
}

for (let day = 1; day <= lastDay.getDate(); day++) {
const dayElement = document.createElement('div');
dayElement.className = 'calendar-day';

const date = new Date(year, month, day);
const dateString = formatDate(date);
const dayOfWeek = date.getDay();

if (dayOfWeek === 0) dayElement.className += ' sunday';
if (dayOfWeek === 6) dayElement.className += ' saturday';

if (holidays[dateString]) {
dayElement.className += ' holiday';
dayElement.title = holidays[dateString];
}

if (!isDateSelectable(date)) {
dayElement.className += ' disabled';
} else {
dayElement.onclick = function() { toggleDate(dateString, dayElement); };
}

const dayNumber = document.createElement('div');
dayNumber.className = 'calendar-day-number';
dayNumber.textContent = day;
dayElement.appendChild(dayNumber);

if (selectedDates[dateString]) {
const requestType = selectedDates[dateString];
const request = document.createElement('div');

request.className = 'calendar-day-request request-type-' + requestType;
request.textContent = requestType;
dayElement.appendChild(request);

dayElement.className += ' selected selected-' + requestType;
}

calendarElement.appendChild(dayElement);
}
}

function formatDate(date) {
const year = date.getFullYear();
const month = String(date.getMonth() + 1).padStart(2, '0');
const day = String(date.getDate()).padStart(2, '0');
return year + '-' + month + '-' + day;
}

function isDateSelectable(date) {
const now = new Date();
const currentMonthDeadline = new Date(now.getFullYear(), now.getMonth(), 7, 9, 0, 0);

if (now <= currentMonthDeadline) {
const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
return date.getFullYear() === nextMonth.getFullYear() &&
date.getMonth() === nextMonth.getMonth();
} else {
const nextNextMonth = new Date(now.getFullYear(), now.getMonth() + 2, 1);
return date.getFullYear() === nextNextMonth.getFullYear() &&
date.getMonth() === nextNextMonth.getMonth();
}
}

// ============================================
// å¸Œæœ›ç®¡ç†
// ============================================

function setRequestType(type) {
selectedRequestType = type;

document.querySelectorAll('.request-button').forEach(btn => {
btn.classList.remove('active');
});

document.querySelector('[data-type="' + type + '"]').classList.add('active');
}

function toggleDate(dateString, element) {
if (!selectedRequestType) {
alert('å¸Œæœ›ã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}

if (selectedDates[dateString]) {
delete selectedDates[dateString];
} else {
selectedDates[dateString] = selectedRequestType;
}

renderCalendar();
updateSelectedDatesList();
}

function updateSelectedDatesList() {
const list = document.getElementById('selectedDatesList');
list.innerHTML = '';

const sortedDates = Object.keys(selectedDates).sort();

if (sortedDates.length === 0) {
list.innerHTML = '<p style="color: #777;">é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
return;
}

sortedDates.forEach(date => {
const item = document.createElement('div');
item.className = 'selected-date-item';
item.innerHTML =
'<span>' + date + ' - ' + selectedDates[date] + '</span>' +
'<button onclick="removeDate(\'' + date + '\')">å‰Šé™¤</button>';
list.appendChild(item);
});
}

function removeDate(date) {
delete selectedDates[date];
renderCalendar();
updateSelectedDatesList();
}

// ============================================
// ã‚¿ã‚¤ãƒãƒ¼
// ============================================

function startCountdown() {
function updateCountdown() {
const now = new Date();
const currentMonthDeadline = new Date(now.getFullYear(), now.getMonth(), 7, 9, 0, 0);

let deadline;
if (now <= currentMonthDeadline) {
deadline = currentMonthDeadline;
} else {
deadline = new Date(now.getFullYear(), now.getMonth() + 1, 7, 9, 0, 0);
}

const diff = deadline - now;

if (diff > 0) {
const days = Math.floor(diff / (1000 * 60 * 60 * 24));
const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
const seconds = Math.floor((diff % (1000 * 60)) / 1000);

document.getElementById('countdown').textContent =
days + 'æ—¥ ' + hours + 'æ™‚é–“ ' + minutes + 'åˆ† ' + seconds + 'ç§’';
} else {
document.getElementById('countdown').textContent = 'ç· åˆ‡ã‚’éãã¾ã—ãŸ';
setTargetMonth();
renderCalendar();
loadUserRequests();
}
}

updateCountdown();
setInterval(updateCountdown, 1000);
}

// ============================================
// å¸Œæœ›ç®¡ç† (Firestoreç‰ˆ)
// ============================================

async function saveRequestsToFirebase(monthKey, staffUid, data) {
try {
const docRef = firestore.collection('requests').doc(monthKey);

await docRef.update({
[staffUid]: data
});

console.log('å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº† (update):', monthKey, staffUid);
} catch (error) {
if (error.code === 'not-found') {
console.warn('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœªä½œæˆã®ãŸã‚ã€set() ã§æ–°è¦ä½œæˆã—ã¾ã™');
const docRef = firestore.collection('requests').doc(monthKey);
await docRef.set({ [staffUid]: data }, { merge: true });
console.log('å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº† (set):', monthKey, staffUid);
} else {
console.error('å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
throw error;
}
}
}

async function loadUserRequests() {
const year = currentMonth.getFullYear();
const month = currentMonth.getMonth() + 1;
const monthKey = year + '-' + String(month).padStart(2, '0');

try {
const doc = await firestore.collection('requests').doc(monthKey).get({ source: 'server' });

if (doc.exists && doc.data()[currentUser.uid]) {
const submission = doc.data()[currentUser.uid];
selectedDates = submission.dates || {};
} else {
selectedDates = {};
}

originalSelectedDates = JSON.parse(JSON.stringify(selectedDates));

} catch (error) {
console.error("å¸Œæœ›ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
selectedDates = {};
originalSelectedDates = {};
}

updateSelectedDatesList();
}

async function submitRequests() {
if (Object.keys(selectedDates).length === 0) {
if (!confirm('å¸Œæœ›ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç©ºã®å¸Œæœ›ï¼ˆå¸Œæœ›ãªã—ï¼‰ã¨ã—ã¦æå‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
return;
}
}

const year = currentMonth.getFullYear();
const month = currentMonth.getMonth() + 1;
const monthKey = year + '-' + String(month).padStart(2, '0');

if (confirm('ã“ã®å†…å®¹ã§å¸Œæœ›ã‚’æå‡ºã—ã¾ã™ã‹ï¼Ÿ (æå‡ºå¾Œã¯ä¸Šæ›¸ãã‚‚å¯èƒ½ã§ã™)') == false) {
return;
}

const submitButton = document.getElementById('submitButton');
submitButton.disabled = true;
submitButton.textContent = 'é€ä¿¡ä¸­...';

try {
const data = {
dates: selectedDates,
submittedAt: new Date().toISOString(),
staffName: currentUser.name,
originalId: currentUser.originalId
};

await saveRequestsToFirebase(monthKey, currentUser.uid, data);

alert('å¸Œæœ›ãŒæå‡ºã•ã‚Œã¾ã—ãŸï¼');

originalSelectedDates = JSON.parse(JSON.stringify(selectedDates));

await updateSubmissionStatus();

} catch (error) {
alert('æå‡ºã‚¨ãƒ©ãƒ¼: ' + error.message);
} finally {
submitButton.disabled = false;
submitButton.textContent = 'å¸Œæœ›ã‚’æå‡º';
}
}

async function updateSubmissionStatus() {
const year = currentMonth.getFullYear();
const month = currentMonth.getMonth() + 1;
const monthKey = year + '-' + String(month).padStart(2, '0');

try {
const staffSnapshot = await firestore.collection('staff').get({ source: 'server' });

const allStaff = staffSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));

const requestsDoc = await firestore.collection('requests').doc(monthKey).get({ source: 'server' });
const monthRequests = requestsDoc.exists ? requestsDoc.data() : {};

const submitted = [];
const notSubmitted = [];

for (const staff of allStaff) {
if (staff.originalId === 31) continue;

if (monthRequests[staff.uid]) {
submitted.push(staff.name);
} else {
notSubmitted.push(staff.name);
}
}

const totalStaff = submitted.length + notSubmitted.length;
const percentage = (totalStaff > 0) ? Math.round((submitted.length / totalStaff) * 100) : 0;

document.getElementById('submissionStatusContent').innerHTML =
'<div style="background: #E8F5E9; padding: 10px; border-radius: 8px; margin-bottom: 10px;">' +
'<strong>æå‡ºæ¸ˆã¿ (' + submitted.length + 'å):</strong> ' +
(submitted.length > 0 ? submitted.join('ã€') : 'ãªã—') +
'</div>' +
'<div style="background: #FFEBEE; padding: 10px; border-radius: 8px;">' +
'<strong>æœªæå‡º (' + notSubmitted.length + 'å):</strong> ' +
(notSubmitted.length > 0 ? notSubmitted.join('ã€') : 'ãªã—') +
'</div>' +
'<div style="margin-top: 10px; text-align: center;">æå‡ºç‡: ' + percentage + '% (' + submitted.length + '/' + totalStaff + ')</div>';

} catch (error) {
console.error("æå‡ºçŠ¶æ³ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
document.getElementById('submissionStatusContent').innerHTML =
'<span style="color: #EF5350;">æå‡ºçŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (ã‚¨ãƒ©ãƒ¼: ' + error.message + ')</span>';
}
}

function previousMonth() {
alert('å‰æœˆã®å¸Œæœ›å…¥åŠ›æœŸé–“ã¯çµ‚äº†ã—ã¦ã„ã¾ã™');
}

function nextMonth() {
alert('ç¿Œæœˆã®å¸Œæœ›å…¥åŠ›æœŸé–“ã¯ã¾ã é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
}

// ============================================
// ç®¡ç†è€…æ©Ÿèƒ½
// ============================================

async function renderAdminTable() {
const year = currentMonth.getFullYear();
const month = currentMonth.getMonth() + 1;
const monthKey = year + '-' + String(month).padStart(2, '0');

document.getElementById('adminMonth').textContent = year + 'å¹´' + month + 'æœˆã®å¸Œæœ›ä¸€è¦§';

try {
const staffSnapshot = await firestore.collection('staff').get({ source: 'server' });

staffListForAdmin = staffSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));

staffListForAdmin.sort((a, b) => (a.originalId || 0) - (b.originalId || 0));

const requestsDoc = await firestore.collection('requests').doc(monthKey).get({ source: 'server' });
allRequestsForAdmin = requestsDoc.exists ? requestsDoc.data() : {};

const header = document.getElementById('adminTableHeader');
header.innerHTML = '<th>ID</th><th>ãƒãƒ¼ãƒ </th><th>è·å“¡å</th>';
const daysInMonth = new Date(year, month, 0).getDate();
for (let day = 1; day <= daysInMonth; day++) {
header.innerHTML += '<th>' + day + '</th>';
}

const tbody = document.getElementById('adminTableBody');
tbody.innerHTML = '';

for (const staffMember of staffListForAdmin) {
if (staffMember.originalId === 31) continue;

let row = '<tr>';
row += `<td>${staffMember.originalId || ''}</td>`;
row += `<td>${staffMember.team || ''}</td>`;

let nameDisplay = staffMember.name;
if (staffMember.leader) {
nameDisplay += ' <span style="color: #fd7e14; font-weight: bold;">L</span>';
}
row += `<td>${nameDisplay}</td>`;

const staffRequestData = allRequestsForAdmin[staffMember.uid];
const dates = staffRequestData ? staffRequestData.dates : {};

for (let day = 1; day <= daysInMonth; day++) {
const dateString = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
const cellContent = dates[dateString] || '';

let cellStyle = '';
switch(cellContent) {
case 'ä¼‘': cellStyle = 'background: #FFEBEE;'; break;
case 'å¹´': cellStyle = 'background: #E3F2FD;'; break;
case 'å‡º': cellStyle = 'background: #FFF8E1;'; break;
case 'æ—¥': cellStyle = 'background: #E8F5E9;'; break;
case 'ç‰¹': cellStyle = 'background: #F3E5F5;'; break;
case 'AM': cellStyle = 'background: #E1F5FE;'; break;
case 'PM': cellStyle = 'background: #E8EAF6;'; break;
case 'å¤': cellStyle = 'background: #FFF3E0;'; break;
}
row += `<td style="${cellStyle}">${cellContent}</td>`;
}

row += '</tr>';
tbody.innerHTML += row;
}

} catch (error) {
console.error("ç®¡ç†è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»ã‚¨ãƒ©ãƒ¼:", error);
document.getElementById('adminTableBody').innerHTML =
`<tr><td colspan="34" style="color: red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</td></tr>`;
}
}

async function showPreviousMonth() {
currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
await renderAdminTable();
}
async function showCurrentMonth() {
currentMonth = new Date();
await renderAdminTable();
}
async function showNextMonth() {
currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
await renderAdminTable();
}

function exportToCSV() {
const year = currentMonth.getFullYear();
const month = currentMonth.getMonth() + 1;

let csv = 'ID,ãƒãƒ¼ãƒ ,è·å“¡å';
const daysInMonth = new Date(year, month, 0).getDate();
for (let day = 1; day <= daysInMonth; day++) { csv += ',' + day + 'æ—¥'; }
csv += '\n';

staffListForAdmin.forEach(staffMember => {
if (staffMember.originalId === 31) return;

csv += `${staffMember.originalId || ''},`;
csv += `${staffMember.team || ''},`;

let name = staffMember.name;
if (staffMember.leader) { name += '(L)'; }
csv += name;

const staffRequestData = allRequestsForAdmin[staffMember.uid];
const dates = staffRequestData ? staffRequestData.dates : {};

for (let day = 1; day <= daysInMonth; day++) {
const dateString = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
csv += ',' + (dates[dateString] || '');
}
csv += '\n';
});

const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
const link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = 'shift_requests_' + year + '_' + month + '.csv';
link.click();
}

// ============================================
// åˆæœŸåŒ–å‡¦ç†
// ============================================

window.addEventListener('DOMContentLoaded', async function() {
console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

if (!initializeFirebase()) {
document.getElementById('loadingSection').innerHTML =
'<div class="loading">' +
'<p style="color: red;">ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ</p>' +
'<p style="font-size: 14px; margin-top: 10px;">è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>' +
'</div>';
return;
}

try {
document.getElementById('loadingSection').classList.add('hidden');
document.getElementById('loginSection').classList.remove('hidden');

document.getElementById('password').addEventListener('keypress', function(e) {
if (e.key === 'Enter') {
login();
}
});

window.addEventListener('beforeunload', (event) => {
if (currentUser && hasUnsavedChanges()) {
event.preventDefault();
event.returnValue = '';
}
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
const modal = document.getElementById('shift-swap-modal');
if (modal) {
modal.addEventListener('click', function(e) {
if (e.target === modal) {
closeSwapModal();
}
});
}

console.log('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');

// â˜…â˜…â˜… åˆ¶ç´„è¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â˜…â˜…â˜…
const constraintToggleBtn = document.getElementById('constraint-toggle-btn');
if (constraintToggleBtn) {
    constraintToggleBtn.addEventListener('click', toggleConstraintPanel);
}

const resetConstraintsBtn = document.getElementById('reset-constraints-btn');
if (resetConstraintsBtn) {
    resetConstraintsBtn.addEventListener('click', resetConstraints);
}

const relaxConstraintsBtn = document.getElementById('relax-constraints-btn');
if (relaxConstraintsBtn) {
    relaxConstraintsBtn.addEventListener('click', relaxConstraints);
}

// ============================================
// GASå‘¼ã³å‡ºã—ã¨çµæœè¡¨ç¤º
// ============================================

const generateBtn = document.getElementById('generate-schedule-btn');
const resultsArea = document.getElementById('schedule-results');

const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz4E_SmydlpReF1vyieqI6ViCkHMfmVxFF4rEkhBD3JOqNdu0YGe9OI5Oxec5rO4Aeb5g/exec";

async function callGASWithJSONP(url) {
// JSONPã®ä»£ã‚ã‚Šã«fetchã‚’ä½¿ç”¨ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¯¾å¿œï¼‰
const separator = url.includes('?') ? '&' : '?';
const callbackName = 'gasCallback_' + Date.now();
const fullUrl = url + separator + 'callback=' + callbackName;

try {
// ã¾ãšfetchã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¿½è·¡
const response = await fetch(fullUrl, {
method: 'GET',
redirect: 'follow'
});

const text = await response.text();

// JSONPå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONã‚’æŠ½å‡º
// å½¢å¼: callbackName({...})
const match = text.match(/^[^(]+\(([\s\S]*)\)$/);
if (match) {
return JSON.parse(match[1]);
}

// JSONå½¢å¼ã®å ´åˆ
try {
return JSON.parse(text);
} catch (e) {
throw new Error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—: ' + text.substring(0, 100));
}

} catch (fetchError) {
console.log('Fetchå¤±æ•—ã€JSONPã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', fetchError);

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®JSONPæ–¹å¼
return new Promise((resolve, reject) => {
const script = document.createElement('script');

const timeout = setTimeout(() => {
delete window[callbackName];
if (script.parentNode) script.parentNode.removeChild(script);
reject(new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'));
}, 30000);

window[callbackName] = function(data) {
clearTimeout(timeout);
delete window[callbackName];
if (script.parentNode) script.parentNode.removeChild(script);
resolve(data);
};

script.onerror = function() {
clearTimeout(timeout);
delete window[callbackName];
if (script.parentNode) script.parentNode.removeChild(script);
reject(new Error('ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
};

script.src = fullUrl;
document.body.appendChild(script);
});
}
}
// â˜…â˜…â˜… ä¿å­˜æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚€ãƒœã‚¿ãƒ³ â˜…â˜…â˜…
// â˜…â˜…â˜… ä¿å­˜æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚€ãƒœã‚¿ãƒ³ â˜…â˜…â˜…
const loadBtn = document.getElementById('load-schedule-btn');
if (loadBtn) {
loadBtn.addEventListener('click', async () => {
const year = currentMonth.getFullYear();
const month = currentMonth.getMonth() + 1;
const monthKey = year + '-' + String(month).padStart(2, '0');

if (!confirm(year + 'å¹´' + month + 'æœˆ ã®ä¿å­˜æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ')) {
return;
}

loadBtn.disabled = true;
loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...';
resultsArea.innerHTML = '<p style="color: #1976D2;">Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...</p>';

try {
// Firestoreã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€
const scheduleDoc = await firestore.collection('Schedules').doc(monthKey).get();

if (!scheduleDoc.exists) {
throw new Error(monthKey + ' ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
}

const data = scheduleDoc.data();

if (!data.drafts || !data.drafts.draft1) {
throw new Error(monthKey + ' ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™');
}

console.log("âœ… Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿æˆåŠŸ:", data);

// è¡¨ç¤º
displayScheduleResults(data, monthKey);

resultsArea.insertAdjacentHTML('afterbegin',
'<div style="background: #E3F2FD; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
'<p style="color: #1976D2; margin: 0;">' +
'<i class="fas fa-info-circle"></i> ' +
'ä¿å­˜æ¸ˆã¿ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ' + formatTimestamp(data.createdAt) + 'ï¼‰' +
'</p>' +
'</div>'
);

} catch (error) {
console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
resultsArea.innerHTML =
'<div style="background: #FFEBEE; padding: 15px; border-radius: 8px;">' +
'<p class="error-message">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>' +
'<p style="font-size: 12px; color: #666; margin-top: 10px;">' +
error.message +
'</p>' +
'</div>';
} finally {
loadBtn.disabled = false;
loadBtn.innerHTML = '<i class="fas fa-folder-open"></i> ä¿å­˜æ¸ˆã¿ã‚’èª­ã¿è¾¼ã‚€';
}
});
}

generateBtn.addEventListener('click', async function() {
const year = currentMonth.getFullYear();
const month = currentMonth.getMonth() + 1;
const monthKey = year + '-' + String(month).padStart(2, '0');

if (!confirm(year + 'å¹´' + month + 'æœˆ ã®å‹¤å‹™è¡¨ã®ä½œæˆã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ')) {
return;
}

generateBtn.disabled = true;
generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ã‚¸ãƒ§ãƒ–ã‚’ç™»éŒ²ä¸­...';
resultsArea.innerHTML = '<p style="color: #00897B;">å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</p>';

try {
// åˆ¶ç´„è¨­å®šã‚’å–å¾—
const constraints = getConstraintSettings();
const constraintParams = 
// äººæ•°ãƒ»å›æ•°åˆ¶ç´„
'&c_nightCount=' + (constraints.nightCount ? '1' : '0') +
'&c_staffCount=' + (constraints.staffCount ? '1' : '0') +
'&c_teamBalance=' + (constraints.teamBalance ? '1' : '0') +
'&c_leaderRequired=' + (constraints.leaderRequired ? '1' : '0') +
// ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¶ç´„
'&c_junKyuuShin=' + (constraints.junKyuuShin ? '1' : '0') +
'&c_kyuuKyuuShin=' + (constraints.kyuuKyuuShin ? '1' : '0') +
'&c_day4Consecutive=' + (constraints.day4Consecutive ? '1' : '0') +
'&c_nightInterval=' + (constraints.nightInterval ? '1' : '0') +
'&c_junBeforeRest=' + (constraints.junBeforeRest ? '1' : '0') +
'&c_junToShin=' + (constraints.junToShin ? '1' : '0') +
'&c_dayToShin=' + (constraints.dayToShin ? '1' : '0') +
'&c_patternBonus=' + (constraints.patternBonus ? '1' : '0');

const createUrl = GAS_API_URL + '?action=create&month=' + monthKey + constraintParams + '&v=' + new Date().getTime();
console.log("ã‚¸ãƒ§ãƒ–ç™»éŒ²URL:", createUrl);
console.log("åˆ¶ç´„è¨­å®š:", constraints);

const createResult = await callGASWithJSONP(createUrl);
console.log("ã‚¸ãƒ§ãƒ–ç™»éŒ²çµæœ:", createResult);

if (!createResult.success) {
throw new Error(createResult.message);
}

const jobId = createResult.jobId;
console.log("ã‚¸ãƒ§ãƒ–ID:", jobId);

generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‡¦ç†ä¸­...';
resultsArea.innerHTML =
'<p style="color: #00897B;">' +
'<i class="fas fa-cog fa-spin"></i> ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç”Ÿæˆä¸­ã§ã™...<br>' +
'<span style="font-size: 12px;">ã“ã®å‡¦ç†ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</span>' +
'</p>';

const scheduleData = await pollJobStatus(jobId, monthKey);

displayScheduleResults(scheduleData, monthKey);

} catch (error) {
console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼:', error);
resultsArea.innerHTML =
'<div style="background: #FFEBEE; padding: 15px; border-radius: 8px;">' +
'<p class="error-message">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>' +
'<p style="font-size: 12px; color: #666; margin-top: 10px;">' +
error.message +
'</p>' +
'</div>';
} finally {
generateBtn.disabled = false;
generateBtn.innerHTML = '<i class="fas fa-magic"></i> å‹¤å‹™è¡¨ã®ä½œæˆã‚’é–‹å§‹';
}
});


async function pollJobStatus(jobId, monthKey) {
const maxAttempts = 180; // 15åˆ† (5ç§’Ã—180)
const interval = 5000;
let attempt = 0;

// â˜…OR-Toolsç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ã‚°ãƒ¬ã‚¹UI
showSimpleProgressUI();

while (attempt < maxAttempts) {
attempt++;

try {
const statusUrl = GAS_API_URL + '?action=checkJob&jobId=' + jobId + '&v=' + new Date().getTime();
const statusResult = await callGASWithJSONP(statusUrl);

console.log("ã‚¸ãƒ§ãƒ–çŠ¶æ…‹:", statusResult);

if (!statusResult.success) {
throw new Error("ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ");
}

const status = statusResult.status;
const progress = statusResult.progress;

if (status === "completed") {
console.log("å‡¦ç†å®Œäº†!çµæœã‚’å–å¾—ã—ã¾ã™...");
updateSimpleProgressUI(100, 'å®Œäº†ã—ã¾ã—ãŸï¼'); // â˜…100%ã«æ›´æ–°

const scheduleUrl = GAS_API_URL + '?action=getSchedule&month=' + monthKey + '&v=' + new Date().getTime();
const scheduleResult = await callGASWithJSONP(scheduleUrl);

if (!scheduleResult.success) {
throw new Error("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + scheduleResult.message);
}

return scheduleResult.data;

} else if (status === "failed") {
throw new Error("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");

} else if (status === "processing" || status === "pending") {
// â˜…ã‚·ãƒ³ãƒ—ãƒ«ãªé€²æ—è¡¨ç¤º
const estimatedPercentage = Math.min((attempt * 0.8), 95);
const elapsedSeconds = attempt * interval / 1000;
updateSimpleProgressUI(estimatedPercentage, 'OR-Toolsã§æœ€é©åŒ–ä¸­... (' + elapsedSeconds + 'ç§’çµŒé)');

await sleep(interval);
continue;

} else {
throw new Error("ä¸æ˜ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: " + status);
}

} catch (error) {
console.error("ãƒãƒ¼ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:", error);
if (attempt >= maxAttempts) {
throw new Error("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™");
}
await sleep(interval);
}
}

throw new Error("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: å‡¦ç†ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ");
}

// â˜…æ–°è¦é–¢æ•°: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ã‚°ãƒ¬ã‚¹UIã‚’è¡¨ç¤º
function showSimpleProgressUI() {
resultsArea.innerHTML = `
<div class="progress-container">
<div class="progress-header">
<div class="progress-status processing">
<span class="spinner"></span> OR-Toolsã§æœ€é©åŒ–ä¸­...
</div>
<div class="progress-time" id="simple-progress-elapsed">çµŒéæ™‚é–“: 0ç§’</div>
</div>

<div class="progress-bar-container">
<div class="progress-bar" id="simple-progress-bar" style="width: 0%;">
0%
</div>
</div>

<div style="text-align: center; padding: 20px; color: #666; font-size: 14px;">
<p>â³ Cloud Runã§æœ€é©åŒ–å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã§ã™</p>
<p style="font-size: 12px; margin-top: 10px;">
ã“ã®å‡¦ç†ã«ã¯5ã€œ10åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™<br>
ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚ã€çµæœã¯ä¿å­˜ã•ã‚Œã¾ã™
</p>
</div>
</div>
`;
}

// â˜…æ–°è¦é–¢æ•°: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ã‚°ãƒ¬ã‚¹UIã‚’æ›´æ–°
function updateSimpleProgressUI(percentage, message) {
const progressBar = document.getElementById('simple-progress-bar');
const statusEl = document.querySelector('.progress-status');

if (progressBar) {
progressBar.style.width = percentage + '%';
progressBar.textContent = Math.round(percentage) + '%';
}

if (statusEl) {
statusEl.innerHTML = '<span class="spinner"></span> ' + message;
}
}

function sleep(ms) {
return new Promise(resolve => setTimeout(resolve, ms));
}

function formatScoreBreakdown(draft) {
// score_breakdown ãŒãªã„å ´åˆ
if (!draft || !draft.score_breakdown) {
if (draft && typeof draft.score !== 'undefined') {
let html = '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">';
html += '<h4 style="margin-top: 0;">ğŸ“Š ã‚¹ã‚³ã‚¢: ' + draft.score + 'ç‚¹</h4>';
html += '<p style="font-size: 0.9em; color: #666;">å¸Œæœ›å……è¶³: ' + (draft.fulfilled_requests || '?') + '/' + (draft.total_requests || '?') + 'ä»¶</p>';
html += '</div>';
return html;
}
return '';
}

const breakdown = draft.score_breakdown;
let html = '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">';
html += '<h4 style="margin-top: 0;">ğŸ“Š ã‚¹ã‚³ã‚¢è¨ˆç®—ã®å†…è¨³</h4>';
html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';

// å¸Œæœ›å……è¶³ã‚¹ã‚³ã‚¢
html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;">âœ… å¸Œæœ›å……è¶³ãƒœãƒ¼ãƒŠã‚¹</td>';
html += '<td style="padding: 8px; text-align: right; color: #4CAF50; font-weight: bold;">+' + (breakdown.request_score || 0) + 'ç‚¹</td></tr>';

// å‹¤å‹™æ—¥æ•°ãƒšãƒŠãƒ«ãƒ†ã‚£
if (breakdown.work_fairness_penalty) {
html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;">ğŸ“‰ å‹¤å‹™æ—¥æ•°ã®åã‚Š</td>';
html += '<td style="padding: 8px; text-align: right; color: #F44336;">' + breakdown.work_fairness_penalty + 'ç‚¹</td></tr>';
}

// æ·±å¤œå›æ•°ãƒšãƒŠãƒ«ãƒ†ã‚£
if (breakdown.night_fairness_penalty) {
html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;">ğŸŒ™ æ·±å¤œå›æ•°ã®åã‚Š</td>';
html += '<td style="padding: 8px; text-align: right; color: #F44336;">' + breakdown.night_fairness_penalty + 'ç‚¹</td></tr>';
}

// åˆè¨ˆ
html += '<tr style="background: #e3f2fd;"><td style="padding: 10px; font-weight: bold;">åˆè¨ˆã‚¹ã‚³ã‚¢</td>';
html += '<td style="padding: 10px; text-align: right; font-weight: bold; font-size: 1.3em; color: #1976D2;">' + (draft.score || 0) + 'ç‚¹</td></tr>';
html += '</table>';

// ã‚¹ã‚³ã‚¢ã®ç›®å®‰
html += '<div style="margin-top: 15px; padding: 10px; background: #fff; border-radius: 4px;">';
html += '<p style="margin: 0 0 8px 0; font-weight: bold; font-size: 13px;">ğŸ“ˆ ã‚¹ã‚³ã‚¢ã®ç›®å®‰:</p>';
html += '<div style="font-size: 12px;">';
html += '<span style="color: #4CAF50;">â– +100ä»¥ä¸Š:éå¸¸ã«è‰¯ã„</span> ';
html += '<span style="color: #8BC34A;">â– +50ã€œ100:è‰¯ã„</span> ';
html += '<span style="color: #FFC107;">â– +20ã€œ50:æ™®é€š</span> ';
html += '<span style="color: #F44336;">â– ãƒã‚¤ãƒŠã‚¹:è¦æ”¹å–„</span>';
html += '</div></div></div>';

return html;
}

function displayScheduleResults(data, monthKey) {
console.log("=== displayScheduleResults é–‹å§‹ ===");
console.log("å—ä¿¡ãƒ‡ãƒ¼ã‚¿:", data);

currentScheduleData = data;

if (!currentScheduleData.monthKey) {
currentScheduleData.monthKey = monthKey;
}

// â˜…CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
window.currentMonthKey = monthKey;

const parts = monthKey.split('-');
const year = parseInt(parts[0]);
const month = parseInt(parts[1]);
currentMonth = new Date(year, month - 1, 1);

// â˜…â˜…â˜… ä¿®æ­£: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèªã—ã¦draftã‚’å–å¾— â˜…â˜…â˜…
let draft = null;

if (data.drafts && data.drafts.draft1) {
draft = data.drafts.draft1;
console.log("drafts.draft1 å½¢å¼ã§å–å¾—");
} else if (data.schedule) {
draft = {
schedule: data.schedule,
validation: data.validation || { criticalErrors: [], warnings: [] },
type: 'è‡ªå‹•ç”Ÿæˆ',
attempts: data.attempt || 1,
score: data.score,
elapsedTime: data.execution_time
};
currentScheduleData.drafts = { draft1: draft };
console.log("scheduleç›´æ¥å½¢å¼ã§å–å¾—");
} else {
console.error("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", Object.keys(data));
resultsArea.innerHTML =
'<div style="background: #FFEBEE; padding: 15px; border-radius: 8px;">' +
'<p class="error-message">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>' +
'</div>';
return;
}

// â˜…CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
// â˜…â˜…â˜… ä¿®æ­£: schedule.scheduleã®äºŒé‡æ§‹é€ ã«å¯¾å¿œ â˜…â˜…â˜…
let actualSchedule = draft.schedule;
if (draft.schedule && draft.schedule.schedule) {
  console.log("äºŒé‡æ§‹é€ ã‚’æ¤œå‡º: draft.schedule.schedule ã‚’ä½¿ç”¨");
  actualSchedule = draft.schedule.schedule;
}
window.currentScheduleForCSV = actualSchedule;
window.currentStaffListForCSV = staffListForAdmin;

// çµæœãƒ˜ãƒƒãƒ€ãƒ¼
const score = draft.score || data.score;
const execTime = draft.elapsedTime || data.execution_time;
const attempts = draft.attempts || data.attempt || 1;

// ============================================================
// index.html ã® displayScheduleResults é–¢æ•°å†…ã‚’ä¿®æ­£
// 2522è¡Œç›®ã€œ2527è¡Œç›®ä»˜è¿‘ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆ
// ============================================================

let statusHtml = '<div style="background: #E8F5E9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
statusHtml += '<h4 style="color: #2E7D32;"><i class="fas fa-check-circle"></i> ä½œæˆå®Œäº†</h4>';
statusHtml += '<p style="font-size: 13px; color: #555;">è¨ˆç®—æ™‚é–“: ' + (execTime ? parseFloat(execTime).toFixed(2) : '?') + 'ç§’ / è©¦è¡Œå›æ•°: ' + attempts + '</p>';
statusHtml += '</div>';

// â˜…â˜…â˜… ã‚¹ã‚³ã‚¢å†…è¨³ã‚’è¡¨ç¤º â˜…â˜…â˜…
// dataã¨draftã®ä¸¡æ–¹ã‹ã‚‰å€¤ã‚’å–å¾—ï¼ˆã©ã¡ã‚‰ã«å…¥ã£ã¦ã„ã‚‹ã‹ä¸æ˜ãªãŸã‚ï¼‰
const fulfilledReqs = data.fulfilled_requests || draft.fulfilled_requests || 0;
const totalReqs = data.total_requests || draft.total_requests || 0;
const scoreBreakdown = data.score_breakdown || draft.score_breakdown || null;
const finalScore = score || data.score || draft.score || 0;

statusHtml += '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
statusHtml += '<h4 style="margin-top: 0; color: #333;">ğŸ“Š ã‚¹ã‚³ã‚¢è¨ˆç®—ã®å†…è¨³</h4>';
statusHtml += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';

// å¸Œæœ›å……è¶³ï¼ˆREQUEST_WEIGHT = 2ï¼‰
const requestScore = scoreBreakdown ? scoreBreakdown.request_score : (fulfilledReqs * 2);
statusHtml += '<tr style="border-bottom: 1px solid #ddd;">';
statusHtml += '<td style="padding: 8px;">âœ… å¸Œæœ›å……è¶³ãƒœãƒ¼ãƒŠã‚¹ (' + fulfilledReqs + '/' + totalReqs + 'ä»¶ Ã— 2ç‚¹)</td>';
statusHtml += '<td style="padding: 8px; text-align: right; color: #4CAF50; font-weight: bold;">+' + requestScore + 'ç‚¹</td>';
statusHtml += '</tr>';

// å‹¤å‹™æ—¥æ•°ãƒšãƒŠãƒ«ãƒ†ã‚£
if (scoreBreakdown && scoreBreakdown.work_fairness_penalty !== 0) {
statusHtml += '<tr style="border-bottom: 1px solid #ddd;">';
statusHtml += '<td style="padding: 8px;">ğŸ“‰ å‹¤å‹™æ—¥æ•°ã®åã‚ŠãƒšãƒŠãƒ«ãƒ†ã‚£</td>';
statusHtml += '<td style="padding: 8px; text-align: right; color: #F44336; font-weight: bold;">' + scoreBreakdown.work_fairness_penalty + 'ç‚¹</td>';
statusHtml += '</tr>';
}

// æ·±å¤œå›æ•°ãƒšãƒŠãƒ«ãƒ†ã‚£
if (scoreBreakdown && scoreBreakdown.night_fairness_penalty !== 0) {
statusHtml += '<tr style="border-bottom: 1px solid #ddd;">';
statusHtml += '<td style="padding: 8px;">ğŸŒ™ æ·±å¤œå›æ•°ã®åã‚ŠãƒšãƒŠãƒ«ãƒ†ã‚£</td>';
statusHtml += '<td style="padding: 8px; text-align: right; color: #F44336; font-weight: bold;">' + scoreBreakdown.night_fairness_penalty + 'ç‚¹</td>';
statusHtml += '</tr>';
}

// é•·ç”°ã‚¿ã‚¤ãƒ—ã®é«˜å„ªå…ˆå¸Œæœ›ï¼ˆNAGATA_REQUEST_WEIGHT = 50ï¼‰ãŒã‚ã‚Œã°è¡¨ç¤º
// ï¼ˆã“ã‚Œã¯scoreBreakdownã«å«ã¾ã‚Œã¦ã„ãªã„ãŒã€ã‚¹ã‚³ã‚¢ã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ï¼‰

// åˆè¨ˆ
statusHtml += '<tr style="background: #e3f2fd;">';
statusHtml += '<td style="padding: 10px; font-weight: bold;">åˆè¨ˆã‚¹ã‚³ã‚¢</td>';
statusHtml += '<td style="padding: 10px; text-align: right; font-weight: bold; font-size: 1.3em; color: #1976D2;">' + finalScore + 'ç‚¹</td>';
statusHtml += '</tr>';
statusHtml += '</table>';

// ã‚¹ã‚³ã‚¢ã®ç›®å®‰
statusHtml += '<div style="margin-top: 15px; padding: 10px; background: #fff; border-radius: 4px;">';
statusHtml += '<p style="margin: 0 0 8px 0; font-weight: bold; font-size: 13px;">ğŸ“ˆ ã‚¹ã‚³ã‚¢ã®ç›®å®‰:</p>';
statusHtml += '<div style="font-size: 12px;">';
statusHtml += '<span style="color: #4CAF50;">â– +200ä»¥ä¸Š:éå¸¸ã«è‰¯ã„</span> ';
statusHtml += '<span style="color: #8BC34A;">â– +100ã€œ200:è‰¯ã„</span> ';
statusHtml += '<span style="color: #FFC107;">â– +50ã€œ100:æ™®é€š</span> ';
statusHtml += '<span style="color: #F44336;">â– ãƒã‚¤ãƒŠã‚¹:è¦æ”¹å–„</span>';
statusHtml += '</div></div>';

// è¨ˆç®—å¼ã®èª¬æ˜
statusHtml += '<details style="margin-top: 10px;">';
statusHtml += '<summary style="cursor: pointer; font-size: 12px; color: #666;">è¨ˆç®—å¼ã®è©³ç´°ã‚’è¦‹ã‚‹</summary>';
statusHtml += '<div style="margin-top: 8px; padding: 10px; background: #fff; border-radius: 4px; font-size: 12px; color: #555;">';
statusHtml += '<p style="margin: 5px 0;"><strong>å¸Œæœ›å……è¶³:</strong> å¶ã£ãŸå¸Œæœ›æ•° Ã— 2ç‚¹</p>';
statusHtml += '<p style="margin: 5px 0;"><strong>å‹¤å‹™æ—¥æ•°ãƒšãƒŠãƒ«ãƒ†ã‚£:</strong> |å®Ÿéš›ã®å‹¤å‹™æ—¥æ•° - 20æ—¥| Ã— 1ç‚¹ï¼ˆå„ã‚¹ã‚¿ãƒƒãƒ•ã”ã¨ï¼‰</p>';
statusHtml += '<p style="margin: 5px 0;"><strong>æ·±å¤œå›æ•°ãƒšãƒŠãƒ«ãƒ†ã‚£:</strong> |å®Ÿéš›ã®æ·±å¤œå›æ•° - 6å›| Ã— 1ç‚¹ï¼ˆå„ã‚¹ã‚¿ãƒƒãƒ•ã”ã¨ï¼‰</p>';
statusHtml += '<p style="margin: 5px 0;"><strong>æ—¥å‹¤å°‚å¾“è€…ã®å¸Œæœ›:</strong> å¶ã£ãŸå¸Œæœ› Ã— 50ç‚¹ï¼ˆé€šå¸¸ã‚ˆã‚Šé«˜å„ªå…ˆï¼‰</p>';
statusHtml += '</div>';
statusHtml += '</details>';

statusHtml += '</div>';

resultsArea.innerHTML = statusHtml;
// â˜…â˜…â˜… ã‚¹ã‚³ã‚¢å†…è¨³ã‚’è¿½åŠ  â˜…â˜…â˜…
const scoreBreakdownHtml = formatScoreBreakdown(draft);
resultsArea.innerHTML += scoreBreakdownHtml;

if (!draft.schedule && !actualSchedule) {
resultsArea.innerHTML += '<p style="color: red;">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
return;
}

// ä»¥ä¸‹ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼ˆdraftãŒå®šç¾©æ¸ˆã¿ãªã®ã§å‹•ä½œã™ã‚‹ï¼‰
const hasCriticalErrors = draft.validation &&
draft.validation.criticalErrors &&
draft.validation.criticalErrors.length > 0;

const draftDiv = document.createElement('div');
draftDiv.style = "margin-top: 20px; border: 1px solid #E0E0E0; border-radius: 8px; overflow: hidden;";

if (hasCriticalErrors) {
let errorsHtml = '<ul style="color: #D32F2F; margin-left: 20px;">';
for (let i = 0; i < draft.validation.criticalErrors.length; i++) {
errorsHtml += '<li>' + draft.validation.criticalErrors[i] + '</li>';
}
errorsHtml += '</ul>';

draftDiv.innerHTML =
'<div style="background: #FFEBEE; padding: 10px 15px;">' +
'<h4 style="color: #D32F2F;">' + (draft.type || 'å‹¤å‹™è¡¨') + ' âš ï¸ å¿…é ˆæ¡ä»¶æœªé”</h4>' +
'</div>' +
'<div style="padding: 15px; background: #FFF9F9;">' +
errorsHtml +
'</div>';
resultsArea.appendChild(draftDiv);
return;
}

const warningCount = draft.validation && draft.validation.warnings ? draft.validation.warnings.length : 0;
const validationStatus = warningCount === 0
? '<span style="color: #2E7D32;">âœ“ ã™ã¹ã¦ã®å¿…é ˆæ¡ä»¶ã‚’ã‚¯ãƒªã‚¢</span>'
: '<span style="color: #F57C00;">âš  è­¦å‘Š ' + warningCount + 'ä»¶</span>';

draftDiv.innerHTML =
'<div style="background: #F8F8F8; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;">' +
'<h4 style="color: #5D4037;">' + (draft.type || 'å‹¤å‹™è¡¨') + '</h4>' +
'<div>' + validationStatus + '</div>' +
'</div>';

if (warningCount > 0) {
const warningDiv = document.createElement('div');
warningDiv.style = "padding: 10px 15px; background: #FFF3E0; border-left: 4px solid #F57C00;";
let warningsHtml = '<ul style="margin: 5px 0 0 20px; color: #E65100;">';
for (let i = 0; i < Math.min(10, draft.validation.warnings.length); i++) {
warningsHtml += '<li>' + draft.validation.warnings[i] + '</li>';
}
warningsHtml += '</ul>';
warningDiv.innerHTML = '<strong style="color: #E65100;">è­¦å‘Šäº‹é …:</strong>' + warningsHtml;
draftDiv.appendChild(warningDiv);
}

const scheduleDiv = document.createElement('div');
scheduleDiv.style = "padding: 15px; overflow-x: auto;";
// â˜…â˜…â˜… ä¿®æ­£: actualScheduleã‚’ä½¿ç”¨ â˜…â˜…â˜…
scheduleDiv.innerHTML = generateScheduleTableHTML(actualSchedule, monthKey, staffListForAdmin) +
'<button id="confirm-draft1" style="background: #1976D2; margin-top: 15px; width: auto; padding: 8px 15px; font-size: 14px;">' +
'<i class="fas fa-check"></i> ã“ã®æ¡ˆã§ç¢ºå®šã™ã‚‹</button>';

draftDiv.appendChild(scheduleDiv);
resultsArea.appendChild(draftDiv);

document.getElementById('confirm-draft1').addEventListener('click', function() {
confirmSchedule('draft1');
});

enableShiftSwap('draft1');
console.log("=== displayScheduleResults å®Œäº† ===");
}


async function confirmSchedule(draftKey) {
if (!confirm('ã€Œ' + draftKey + 'ã€ã‚’æœ€çµ‚çš„ãªå‹¤å‹™è¡¨ã¨ã—ã¦ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ\nç¢ºå®šå¾Œã¯è‡ªå‹•ç”Ÿæˆã«ã‚ˆã‚‹ä¸Šæ›¸ããŒã§ããªããªã‚Šã¾ã™ã€‚')) {
return;
}

try {
const monthKey = currentMonth.toISOString().slice(0, 7);

console.log("ç¢ºå®šå‡¦ç†é–‹å§‹:", monthKey, draftKey);

const scheduleRef = firestore.collection('Schedules').doc(monthKey);
const scheduleDoc = await scheduleRef.get();

if (!scheduleDoc.exists) {
throw new Error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
}

const currentData = scheduleDoc.data();

if (!currentData.drafts || !currentData.drafts[draftKey]) {
throw new Error('draft ' + draftKey + ' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
}

// ç¢ºå®šãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
currentData.drafts[draftKey].confirmed = true;
currentData.drafts[draftKey].confirmedAt = firebase.firestore.FieldValue.serverTimestamp();
currentData.drafts[draftKey].confirmedBy = currentUser.name;

// ä¿å­˜
await scheduleRef.set(currentData, { merge: true });

console.log("âœ… å‹¤å‹™è¡¨ãŒç¢ºå®šã•ã‚Œã¾ã—ãŸ");
showMessage('å‹¤å‹™è¡¨ãŒç¢ºå®šã•ã‚Œã¾ã—ãŸ', 'success');

// ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
const confirmBtn = document.getElementById('confirm-draft1');
if (confirmBtn) {
confirmBtn.disabled = true;
confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> ç¢ºå®šæ¸ˆã¿';
confirmBtn.style.background = '#4CAF50';
confirmBtn.style.cursor = 'not-allowed';
}

} catch (error) {
console.error('âŒ ç¢ºå®šã‚¨ãƒ©ãƒ¼:', error);
showMessage('ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
}
}

// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
function exportScheduleToCSV() {
console.log('=== CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹ ===');
console.log('currentScheduleForCSV:', window.currentScheduleForCSV);
console.log('currentStaffListForCSV:', window.currentStaffListForCSV);
console.log('currentMonthKey:', window.currentMonthKey);

if (!window.currentScheduleForCSV || !window.currentStaffListForCSV) {
alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nå…ˆã«ã€Œä¿å­˜æ¸ˆã¿ã‚’èª­ã¿è¾¼ã‚€ã€ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚');
return;
}

const scheduleData = window.currentScheduleForCSV;
const staffList = window.currentStaffListForCSV;
const monthKey = window.currentMonthKey || new Date().toISOString().slice(0, 7);

console.log('scheduleData keys:', Object.keys(scheduleData));
console.log('staffList length:', staffList.length);

const [year, month] = monthKey.split('-').map(Number);
const daysInMonth = new Date(year, month, 0).getDate();
const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

let csv = '\uFEFFåå‰,ãƒãƒ¼ãƒ ';
for (let d = 1; d <= daysInMonth; d++) csv += ',' + d;
csv += ',æ—¥å‹¤,æº–å¤œ,æ·±å¤œ,ä¼‘ã¿\n';

csv += 'æ›œæ—¥,';
for (let d = 1; d <= daysInMonth; d++) {
csv += ',' + dayNames[new Date(year, month - 1, d).getDay()];
}
csv += ',,,\n';

staffList.forEach(staff => {
const uid = staff.uid || staff.id;
const s = scheduleData[uid];
if (!s || !s.shifts) {
console.log('ã‚¹ã‚­ãƒƒãƒ—:', staff.name, uid, s);
return;
}

csv += '"' + (staff.name || '').replace(/"/g, '""') + '",' + (staff.team || '-');
const counts = { 'æ—¥': 0, 'æº–': 0, 'æ·±': 0, 'ä¼‘': 0 };

for (let d = 1; d <= daysInMonth; d++) {
const shift = s.shifts[d] || s.shifts[String(d)] || '-';
csv += ',' + shift;
if (shift === 'æ—¥') counts['æ—¥']++;
else if (shift === 'æº–') counts['æº–']++;
else if (shift === 'æ·±') counts['æ·±']++;
else if (['ä¼‘','å¹´','å‡º','ç‰¹','AM','PM','å¤'].includes(shift)) counts['ä¼‘']++;
}
csv += ',' + counts['æ—¥'] + ',' + counts['æº–'] + ',' + counts['æ·±'] + ',' + counts['ä¼‘'] + '\n';
});

console.log('CSVä½œæˆå®Œäº†, é•·ã•:', csv.length);

try {
const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
const url = URL.createObjectURL(blob);
const link = document.createElement('a');
link.setAttribute('href', url);
link.setAttribute('download', 'å‹¤å‹™è¡¨_' + monthKey + '.csv');
link.style.visibility = 'hidden';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
URL.revokeObjectURL(url);
console.log('CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œå®Œäº†');
} catch (e) {
console.error('CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', e);
alert('CSVã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
}
}

} catch (error) {
console.error('åˆæœŸåŒ–å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
alert('åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
}

});

</script>
</body>
</html>
