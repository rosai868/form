<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ•ãƒˆå¸Œæœ›ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (Firebaseç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        /* ... (å‰å›ã®CSSã¨åŒä¸€ã®ãŸã‚çœç•¥) ... */
        /* ã“ã“ã«ã€å‰å›ã‚ãªãŸãŒæç¤ºã—ãŸ 
           <style>...</style> ã‚¿ã‚°ã®ä¸­èº«ã‚’
           ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
        */

        /* ä¾‹: 
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body { ... }
        .container { ... }
        ... (ä»¥ä¸‹ã€ã™ã¹ã¦) ...
        */
    </style>
</head>
<body>
    <div id="loadingSection" class="container">
        <div class="loading">
            <p>ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...</p>
        </div>
    </div>

    <div id="loginSection" class="container login-container hidden">
        <h1>ã‚·ãƒ•ãƒˆå¸Œæœ›ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="form-group">
            <label for="userId">ID</label>
            <input type="text" id="userId" placeholder="IDã‚’å…¥åŠ›">
        </div>
        <div class="form-group">
            <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        </div>
        <button onclick="login()" id="loginButton">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div style="margin-top: 20px; ...">
            <p>â€» IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã¯å¸«é•·ã«é€£çµ¡ã—ã¦ãã ã•ã„</p>
            <p>â€» ç· ã‚åˆ‡ã‚Šã¯æ¯æœˆ7æ—¥ã§ã™</p>
        </div>
        <div id="loginError" class="error-message"></div>
    </div>

    <div id="changePasswordSection" class="container login-container hidden">
        <h2>åˆå›ãƒ­ã‚°ã‚¤ãƒ³ - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
        <p style="margin-bottom: 20px;">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ5æ¡ã®æ•°å­—ï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
        <div class="form-group">
            <label for="newPassword">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="newPassword" placeholder="5æ¡ã®æ•°å­—" maxlength="5">
        </div>
        <div class="form-group">
            <label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
            <input type="password" id="confirmPassword" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›" maxlength="5">
        </div>
        <button onclick="changePassword()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
        <div id="passwordError" class="error-message"></div>
    </div>

    <div id="mainSection" class="container hidden">
        <h1>ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›</h1>
        <div id="welcomeMessage" style="text-align: center; margin-bottom: 20px;"></div>
        
        <div class="timer">
            <div>ç· åˆ‡ã¾ã§æ®‹ã‚Šæ™‚é–“</div>
            <div id="countdown" class="timer-display">è¨ˆç®—ä¸­...</div>
        </div>

        <div class="calendar-header">
            <button onclick="previousMonth()">å‰æœˆ</button>
            <h2 id="currentMonth"></h2>
            <button onclick="nextMonth()">ç¿Œæœˆ</button>
        </div>

        <div id="calendar"></div>

        <div class="request-buttons">
             <div class="request-button" onclick="setRequestType('ä¼‘')" data-type="ä¼‘">...</div>
             <div class="request-button" onclick="setRequestType('å¹´')" data-type="å¹´">...</div>
             <div class="request-button" onclick="setRequestType('å‡º')" data-type="å‡º">...</div>
             <div class="request-button" onclick="setRequestType('æ—¥')" data-type="æ—¥">...</div>
        </div>

        <div class="selected-dates">
            <h3>é¸æŠæ¸ˆã¿ã®å¸Œæœ›</h3>
            <div id="selectedDatesList"></div>
        </div>

        <button onclick="submitRequests()" id="submitButton">å¸Œæœ›ã‚’æå‡º</button>
        
        <div id="submissionStatus" class="selected-dates" style="margin-top: 15px;">
            <h3>æå‡ºçŠ¶æ³</h3>
            <div id="submissionStatusContent"></div>
        </div>
        
        <button onclick="logout()" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <div id="submitMessage" style="margin-top: 10px;"></div>
    </div>

    <div id="adminSection" class="container hidden">
        <h1>ç®¡ç†è€…ç”»é¢</h1>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button onclick="showPreviousMonth()" style="...">å‰æœˆ</button>
            <button onclick="showCurrentMonth()" style="...">ä»Šæœˆ</button>
            <button onclick="showNextMonth()" style="...">ç¿Œæœˆ</button>
        </div>

        <h2 id="adminMonth"></h2>

        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr id="adminTableHeader"></tr>
                </thead>
                <tbody id="adminTableBody"></tbody>
            </table>
        </div>

        <button onclick="exportToCSV()" style="margin-top: 20px;">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        
        <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 4px; font-size: 13px; color: #333;">
            <h3 style="font-size: 16px; margin-bottom: 15px;">ğŸ”’ è·å“¡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</h3>
            <p>
                è·å“¡ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã¯ã€
                <strong>Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€ŒAuthenticationã€</strong>
                ç”»é¢ã‹ã‚‰ã€è©²å½“ã®è·å“¡ï¼ˆä¾‹: 1@app.comï¼‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚
            </p>
        </div>
        
        <button onclick="logout()" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="syncStatus" class="sync-status hidden">
        <span id="syncText">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
    </div>


    <script>
        // ============================================
        // Firebaseã®è¨­å®šã‚’å¤–éƒ¨ã‹ã‚‰èª­ã¿è¾¼ã¿ (å¤‰æ›´ãªã—)
        // ============================================
        let firebaseConfig = null;
        let auth = null;      // èªè¨¼ç”¨
        let firestore = null; // Firestore DBç”¨
        let db = null;        // (äº’æ›æ€§ã®ãŸã‚æ®‹ã™) Realtime DBç”¨

        function loadFirebaseConfig() {
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (!savedConfig) {
                alert('Firebaseã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚è¨­å®šç”»é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚');
                window.location.href = 'firebase-config.html';
                return false;
            }
            try {
                firebaseConfig = JSON.parse(savedConfig);
                return true;
            } catch (error) {
                alert('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                localStorage.removeItem('firebaseConfig');
                window.location.href = 'firebase-config.html';
                return false;
            }
        }

        // FirebaseåˆæœŸåŒ– (Authã¨Firestoreã‚’è¿½åŠ )
        function initializeFirebase() {
            if (!loadFirebaseConfig()) {
                return false;
            }
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                firestore = firebase.firestore();
                db = firebase.database(); // å…ƒã®ã‚³ãƒ¼ãƒ‰ãŒä½¿ã£ã¦ã„ã‚‹ãªã‚‰æ®‹ã™
                console.log('FirebaseåˆæœŸåŒ–æˆåŠŸ (Auth, Firestore)');
                return true;
            } catch (error) {
                console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return false;
            }
        }

        // ============================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ============================================
        
        // ğŸš¨ è·å“¡ãƒªã‚¹ãƒˆã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é…åˆ—ã¯ã€Œå®Œå…¨ã«å‰Šé™¤ã€
        // const staff = [ ... ];
        // const passwords = { ... };
        // const leaders = [ ... ];
        // const DEFAULT_ADMIN_PASSWORD = '...';

        // ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ (å¤‰æ›´ãªã—)
        const holidays = { '2025-01-01': 'å…ƒæ—¥', ... };

        // çŠ¶æ…‹ç®¡ç† (å¤‰æ›´ãªã—)
        let currentUser = null; // { uid: '...', name: 'é•·å‚', originalId: 1, ... } ã®å½¢å¼ã§ä¿å­˜
        let currentMonth = new Date();
        let selectedDates = {};
        let selectedRequestType = null;
        
        // Adminç”¨
        let staffListForAdmin = []; // ç®¡ç†è€…ç”»é¢ã§ä½¿ã†è·å“¡ãƒªã‚¹ãƒˆ
        let allRequestsForAdmin = {}; // ç®¡ç†è€…ç”»é¢ã§ä½¿ã†å¸Œæœ›ãƒ‡ãƒ¼ã‚¿

        // ============================================
        // ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£ (ğŸš¨ å®Œå…¨ã«æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯)
        // ============================================
        
        async function login() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            
            // è·å“¡IDã‹ã‚‰ã€Œãƒ€ãƒŸãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã‚’çµ„ã¿ç«‹ã¦ã‚‹
            // â˜…â˜…â˜… ã“ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã‚ãªãŸãŒæ±ºã‚ãŸã‚‚ã®ã«ã—ã¦ãã ã•ã„ â˜…â˜…â˜…
            const email = `${userId}@app.com`; // ä¾‹: '1@app.com'

            loginButton.disabled = true;
            loginButton.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
            
            try {
                // 1. Firebase Authenticationã§ãƒ­ã‚°ã‚¤ãƒ³
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // 2. Firestoreã‹ã‚‰è·å“¡åç°¿ã‚’å–å¾—
                const staffDoc = await firestore.collection('staff').doc(user.uid).get();

                if (!staffDoc.exists) {
                    throw new Error('è·å“¡åç°¿ã«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                }

                currentUser = {
                    uid: user.uid,
                    ...staffDoc.data()
                };

                // 3. åˆå›ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒã‚§ãƒƒã‚¯
                if (currentUser.passwordChanged === false) {
                    // åˆå›ãƒ­ã‚°ã‚¤ãƒ³ -> ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢ã¸
                    showChangePasswordSection();
                } else {
                    // é€šå¸¸ãƒ­ã‚°ã‚¤ãƒ³
                    if (currentUser.isAdmin === true) { // ç®¡ç†è€…ãƒ•ãƒ©ã‚°(isAdmin)ã‚’Firestoreã«æŒãŸã›ã‚‹
                        showAdminSection();
                    } else {
                        showMainSection();
                    }
                }

            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    document.getElementById('loginError').textContent = 'IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                } else {
                    document.getElementById('loginError').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
                }
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
            }
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ (ğŸš¨ å®Œå…¨ã«æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯)
        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!/^\d{5}$/.test(newPassword)) {
                document.getElementById('passwordError').textContent = '5æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }
            if (newPassword !== confirmPassword) {
                document.getElementById('passwordError').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“';
                return;
            }

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“');
                }

                // 1. Authã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°
                await user.updatePassword(newPassword);

                // 2. Firestoreã®ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
                await firestore.collection('staff').doc(user.uid).update({
                    passwordChanged: true
                });

                // 3. ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚');
                
                // currentUserã«ã‚‚åæ˜ 
                currentUser.passwordChanged = true;

                if (currentUser.isAdmin === true) {
                    showAdminSection();
                } else {
                    showMainSection();
                }

            } catch (error) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('passwordError').textContent = 'å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ (ğŸš¨ Authã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’è¿½åŠ )
        async function logout() {
            await auth.signOut();
            
            currentUser = null;
            selectedDates = {};
            selectedRequestType = null;
            
            document.getElementById('userId').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').textContent = '';
            
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('changePasswordSection').classList.add('hidden');
            document.getElementById('syncStatus').classList.add('hidden');
        }


        // ============================================
        // ç”»é¢è¡¨ç¤º (ãƒ­ã‚¸ãƒƒã‚¯ã¯ã»ã¼å¤‰æ›´ãªã—)
        // ============================================
        
        function showChangePasswordSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('changePasswordSection').classList.remove('hidden');
        }

        async function showMainSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('changePasswordSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            document.getElementById('syncStatus').classList.remove('hidden');
            
            document.getElementById('welcomeMessage').textContent = currentUser.name + 'ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯';
            
            setTargetMonth();
            startCountdown();
            
            // Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            await loadUserRequests();
            renderCalendar();
            
            // æå‡ºçŠ¶æ³ã‚’æ›´æ–° (Firestoreã‹ã‚‰)
            await updateSubmissionStatus();
        }

        async function showAdminSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            document.getElementById('syncStatus').classList.remove('hidden');
            
            currentMonth = new Date();
            
            // ç®¡ç†è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”» (Firestoreã‹ã‚‰)
            await renderAdminTable();
        }

        // ============================================
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ (ãƒ­ã‚¸ãƒƒã‚¯ã¯ã»ã¼å¤‰æ›´ãªã—)
        // ============================================
        
        function setTargetMonth() { /* ... (å¤‰æ›´ãªã—) ... */ }
        function renderCalendar() { /* ... (å¤‰æ›´ãªã—) ... */ }
        function formatDate(date) { /* ... (å¤‰æ›´ãªã—) ... */ }
        function isDateSelectable(date) { /* ... (å¤‰æ›´ãªã—) ... */ }
        function setRequestType(type) { /* ... (å¤‰æ›´ãªã—) ... */ }
        function toggleDate(dateString, element) { /* ... (å¤‰æ›´ãªã—) ... */ }
        function updateSelectedDatesList() { /* ... (å¤‰æ›´ãªã—) ... */ }
        function removeDate(date) { /* ... (å¤‰æ›´ãªã—) ... */ }
        function startCountdown() { /* ... (å¤‰æ›´ãªã—) ... */ }

        // ============================================
        // å¸Œæœ›ç®¡ç† (ğŸš¨ Firestoreç‰ˆã«æ›¸ãæ›ãˆ)
        // ============================================

        // ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ä¿å­˜
        async function saveRequestsToFirebase(monthKey, staffUid, data) {
            try {
                // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: {YYYY-MM}
                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: { uid: data, uid2: data2 }
                // set + merge:true ã§ã€æŒ‡å®šã—ãŸUIDã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’ä¸Šæ›¸ã
                const docRef = firestore.collection('requests').doc(monthKey);
                await docRef.set({
                    [staffUid]: data
                }, { merge: true });
                
                console.log('å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:', monthKey, staffUid);
            } catch (error) {
                console.error('å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // è‡ªåˆ†ã®å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚€
        async function loadUserRequests() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            const monthKey = year + '-' + String(month).padStart(2, '0');
            
            try {
                const doc = await firestore.collection('requests').doc(monthKey).get();
                
                if (doc.exists && doc.data()[currentUser.uid]) {
                    const submission = doc.data()[currentUser.uid];
                    selectedDates = submission.dates || {};
                } else {
                    selectedDates = {}; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¯ãƒªã‚¢
                }
            } catch (error) {
                console.error("å¸Œæœ›ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                selectedDates = {};
            }
            
            // èª­ã¿è¾¼ã‚“ã ã‚‰ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
            updateSelectedDatesList();
        }

        // å¸Œæœ›ã‚’æå‡º (ğŸš¨ Firestoreç‰ˆ)
        async function submitRequests() {
            /* ... (alertã‚„confirmã¯å¤‰æ›´ãªã—) ... */
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            const monthKey = year + '-' + String(month).padStart(2, '0');
            
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = 'é€ä¿¡ä¸­...';
            
            try {
                const data = {
                    dates: selectedDates,
                    submittedAt: new Date().toISOString(),
                    staffName: currentUser.name,
                    originalId: currentUser.originalId // originalIdã‚‚ä¿å­˜
                };
                
                await saveRequestsToFirebase(monthKey, currentUser.uid, data);
                
                document.getElementById('submitMessage').innerHTML = 
                    '<span class="success-message">å¸Œæœ›ãŒæå‡ºã•ã‚Œã¾ã—ãŸï¼</span>';
                
                // æå‡ºçŠ¶æ³ã‚’æ›´æ–°
                await updateSubmissionStatus();

            } catch (error) {
                 document.getElementById('submitMessage').innerHTML = 
                    '<span class="error-message">æå‡ºã‚¨ãƒ©ãƒ¼: ' + error.message + '</span>';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'å¸Œæœ›ã‚’æå‡º';
            }
        }

        // æå‡ºçŠ¶æ³ã®è¡¨ç¤º (ğŸš¨ Firestoreç‰ˆ)
        async function updateSubmissionStatus() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            const monthKey = year + '-' + String(month).padStart(2, '0');

            try {
                // 1. å…¨è·å“¡ã®ãƒªã‚¹ãƒˆã‚’å–å¾— (ç®¡ç†è€…ã§ãªãã¦ã‚‚å–å¾—ãŒå¿…è¦)
                const staffSnapshot = await firestore.collection('staff').get();
                const allStaff = staffSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                
                // 2. ãã®æœˆã®å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const requestsDoc = await firestore.collection('requests').doc(monthKey).get();
                const monthRequests = requestsDoc.exists ? requestsDoc.data() : {};

                const submitted = [];
                const notSubmitted = [];

                for (const staff of allStaff) {
                    if (staff.isAdmin) continue; // ç®¡ç†è€…ã¯é™¤å¤–
                    
                    if (monthRequests[staff.uid]) {
                        submitted.push(staff.name);
                    } else {
                        notSubmitted.push(staff.name);
                    }
                }
                
                /* ... (innerHTMLã«ã‚»ãƒƒãƒˆã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ... */
                const percentage = Math.round((submitted.length / (submitted.length + notSubmitted.length)) * 100);
                document.getElementById('submissionStatusContent').innerHTML = 
                   '<div ...><strong>æå‡ºæ¸ˆã¿ (' + submitted.length + 'å):</strong> ' + ... + '</div>' +
                   '<div ...><strong>æœªæå‡º (' + notSubmitted.length + 'å):</strong> ' + ... + '</div>' +
                   '<div ...>æå‡ºç‡: ' + percentage + '%</div>';

            } catch (error) {
                console.error("æå‡ºçŠ¶æ³ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById('submissionStatusContent').innerHTML = 
                    '<span style="color: red;">æå‡ºçŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
            }
        }

        // ============================================
        // ç®¡ç†è€…æ©Ÿèƒ½ (ğŸš¨ Firestoreç‰ˆã«æ›¸ãæ›ãˆ)
        // ============================================
        
        async function renderAdminTable() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            const monthKey = year + '-' + String(month).padStart(2, '0');
            
            document.getElementById('adminMonth').textContent = year + 'å¹´' + month + 'æœˆã®å¸Œæœ›ä¸€è¦§';
            
            try {
                // 1. å…¨è·å“¡ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
                const staffSnapshot = await firestore.collection('staff')
                    .orderBy('originalId', 'asc') // originalIdã§ä¸¦ã³æ›¿ãˆ
                    .get();
                staffListForAdmin = staffSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));

                // 2. ãã®æœˆã®å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const requestsDoc = await firestore.collection('requests').doc(monthKey).get();
                allRequestsForAdmin = requestsDoc.exists ? requestsDoc.data() : {};
                
                // 3. ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æç”» (å¤‰æ›´ãªã—)
                const header = document.getElementById('adminTableHeader');
                header.innerHTML = '<th>ID</th><th>ãƒãƒ¼ãƒ </th><th>è·å“¡å</th>';
                const daysInMonth = new Date(year, month, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    header.innerHTML += '<th>' + day + '</th>';
                }

                // 4. ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã‚’æç”»
                const tbody = document.getElementById('adminTableBody');
                tbody.innerHTML = '';
                
                for (const staffMember of staffListForAdmin) {
                    if (staffMember.isAdmin) continue; // ç®¡ç†è€…ã¯ä¸€è¦§ã‹ã‚‰é™¤å¤–

                    let row = '<tr>';
                    row += `<td>${staffMember.originalId || ''}</td>`;
                    row += `<td>${staffMember.team || ''}</td>`; // Firestoreã« 'team' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒãŸã›ã‚‹
                    
                    let nameDisplay = staffMember.name;
                    if (staffMember.leader) { // Firestoreã« 'leader' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒãŸã›ã‚‹
                        nameDisplay += ' <span style="color: #ff9800; font-weight: bold;">L</span>';
                    }
                    row += `<td>${nameDisplay}</td>`;

                    // å¸Œæœ›ãƒ‡ãƒ¼ã‚¿ã‚’æç”»
                    const staffRequestData = allRequestsForAdmin[staffMember.uid];
                    const dates = staffRequestData ? staffRequestData.dates : {};

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                        const cellContent = dates[dateString] || '';
                        let cellStyle = '';
                        /* ... (cellStyleã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ... */
                        row += `<td style="${cellStyle}">${cellContent}</td>`;
                    }
                    
                    row += '</tr>';
                    tbody.innerHTML += row;
                }

            } catch (error) {
                console.error("ç®¡ç†è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById('adminTableBody').innerHTML = 
                    `<tr><td colspan="34" style="color: red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</td></tr>`;
            }
        }

        // æœˆç§»å‹• (å¤‰æ›´ãªã—)
        async function showPreviousMonth() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            await renderAdminTable();
        }
        async function showCurrentMonth() {
            currentMonth = new Date();
            await renderAdminTable();
        }
        async function showNextMonth() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            await renderAdminTable();
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (ğŸš¨ Firestoreã®å¤‰æ•°ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´)
        function exportToCSV() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            
            let csv = 'ID,ãƒãƒ¼ãƒ ,è·å“¡å';
            const daysInMonth = new Date(year, month, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) { csv += ',' + day + 'æ—¥'; }
            csv += '\n';
            
            // staffListForAdmin ã¨ allRequestsForAdmin ã‚’ä½¿ã†
            staffListForAdmin.forEach(staffMember => {
                if (staffMember.isAdmin) return;

                csv += `${staffMember.originalId || ''},`;
                csv += `${staffMember.team || ''},`;
                
                let name = staffMember.name;
                if (staffMember.leader) { name += '(L)'; }
                csv += name;

                const staffRequestData = allRequestsForAdmin[staffMember.uid];
                const dates = staffRequestData ? staffRequestData.dates : {};
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    csv += ',' + (dates[dateString] || '');
                }
                csv += '\n';
            });
            
            /* ... (Blobã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ... */
             const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
             const link = document.createElement('a');
             link.href = URL.createObjectURL(blob);
             link.download = 'shift_requests_' + year + '_' + month + '.csv';
             link.click();
        }

        // ============================================
        // åˆæœŸåŒ–å‡¦ç† (å¤‰æ›´ãªã—)
        // ============================================
        
        // åŒæœŸçŠ¶æ…‹ (å¤‰æ›´ãªã—)
        function updateSyncStatus(status) { /* ... (å¤‰æ›´ãªã—) ... */ }
        function setupRealtimeSync() {
             // (å…ƒã®ã‚³ãƒ¼ãƒ‰ãŒRTDBã‚’ä½¿ã£ã¦ã„ãŸãªã‚‰ã€ãã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«æ®‹ã™)
             // ...
             // Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã¯ .onSnapshot() ã‚’ä½¿ã„ã¾ã™ãŒã€
             // ã²ã¨ã¾ãš .get() ã§ã®èª­ã¿è¾¼ã¿ã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
        }

        window.addEventListener('DOMContentLoaded', async function() {
            console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            if (!initializeFirebase()) {
                document.getElementById('loadingSection').innerHTML = '<div class...';
                return;
            }
            
            try {
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸè¨­å®š (ã‚‚ã—ã‚ã‚Œã°)
                // setupRealtimeSync();
                
                // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('loginSection').classList.remove('hidden');
                
                // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ (å¤‰æ›´ãªã—)
                document.getElementById('password').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
                
                console.log('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('loadingSection').innerHTML = '<div class...';
            }
        });
    </script>
</body>
</html>
