<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト希望管理システム (Firebase版)</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        /* ... (前回のCSSと同一のため省略) ... */
        /* ここに、前回あなたが提示した 
           <style>...</style> タグの中身を
           そのままコピー＆ペーストしてください。
        */

        /* 例: 
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body { ... }
        .container { ... }
        ... (以下、すべて) ...
        */
    </style>
</head>
<body>
    <div id="loadingSection" class="container">
        <div class="loading">
            <p>システムを初期化中...</p>
        </div>
    </div>

    <div id="loginSection" class="container login-container hidden">
        <h1>シフト希望管理システム</h1>
        <div class="form-group">
            <label for="userId">ID</label>
            <input type="text" id="userId" placeholder="IDを入力">
        </div>
        <div class="form-group">
            <label for="password">パスワード</label>
            <input type="password" id="password" placeholder="パスワードを入力">
        </div>
        <button onclick="login()" id="loginButton">ログイン</button>
        <div style="margin-top: 20px; ...">
            <p>※ ID・パスワードを忘れた場合は師長に連絡してください</p>
            <p>※ 締め切りは毎月7日です</p>
        </div>
        <div id="loginError" class="error-message"></div>
    </div>

    <div id="changePasswordSection" class="container login-container hidden">
        <h2>初回ログイン - パスワード変更</h2>
        <p style="margin-bottom: 20px;">新しいパスワード（5桁の数字）を設定してください</p>
        <div class="form-group">
            <label for="newPassword">新しいパスワード</label>
            <input type="password" id="newPassword" placeholder="5桁の数字" maxlength="5">
        </div>
        <div class="form-group">
            <label for="confirmPassword">パスワード確認</label>
            <input type="password" id="confirmPassword" placeholder="もう一度入力" maxlength="5">
        </div>
        <button onclick="changePassword()">パスワード変更</button>
        <div id="passwordError" class="error-message"></div>
    </div>

    <div id="mainSection" class="container hidden">
        <h1>シフト希望入力</h1>
        <div id="welcomeMessage" style="text-align: center; margin-bottom: 20px;"></div>
        
        <div class="timer">
            <div>締切まで残り時間</div>
            <div id="countdown" class="timer-display">計算中...</div>
        </div>

        <div class="calendar-header">
            <button onclick="previousMonth()">前月</button>
            <h2 id="currentMonth"></h2>
            <button onclick="nextMonth()">翌月</button>
        </div>

        <div id="calendar"></div>

        <div class="request-buttons">
             <div class="request-button" onclick="setRequestType('休')" data-type="休">...</div>
             <div class="request-button" onclick="setRequestType('年')" data-type="年">...</div>
             <div class="request-button" onclick="setRequestType('出')" data-type="出">...</div>
             <div class="request-button" onclick="setRequestType('日')" data-type="日">...</div>
        </div>

        <div class="selected-dates">
            <h3>選択済みの希望</h3>
            <div id="selectedDatesList"></div>
        </div>

        <button onclick="submitRequests()" id="submitButton">希望を提出</button>
        
        <div id="submissionStatus" class="selected-dates" style="margin-top: 15px;">
            <h3>提出状況</h3>
            <div id="submissionStatusContent"></div>
        </div>
        
        <button onclick="logout()" class="logout-button">ログアウト</button>
        <div id="submitMessage" style="margin-top: 10px;"></div>
    </div>

    <div id="adminSection" class="container hidden">
        <h1>管理者画面</h1>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button onclick="showPreviousMonth()" style="...">前月</button>
            <button onclick="showCurrentMonth()" style="...">今月</button>
            <button onclick="showNextMonth()" style="...">翌月</button>
        </div>

        <h2 id="adminMonth"></h2>

        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr id="adminTableHeader"></tr>
                </thead>
                <tbody id="adminTableBody"></tbody>
            </table>
        </div>

        <button onclick="exportToCSV()" style="margin-top: 20px;">CSVエクスポート</button>
        
        <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 4px; font-size: 13px; color: #333;">
            <h3 style="font-size: 16px; margin-bottom: 15px;">🔒 職員のパスワードリセット</h3>
            <p>
                職員がパスワードを忘れた場合は、
                <strong>Firebaseコンソールの「Authentication」</strong>
                画面から、該当の職員（例: 1@app.com）のパスワードをリセットしてください。
            </p>
        </div>
        
        <button onclick="logout()" class="logout-button">ログアウト</button>
    </div>

    <div id="syncStatus" class="sync-status hidden">
        <span id="syncText">オンライン</span>
    </div>


    <script>
        // ============================================
        // Firebaseの設定を外部から読み込み (変更なし)
        // ============================================
        let firebaseConfig = null;
        let auth = null;      // 認証用
        let firestore = null; // Firestore DB用
        let db = null;        // (互換性のため残す) Realtime DB用

        function loadFirebaseConfig() {
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (!savedConfig) {
                alert('Firebaseの設定が必要です。設定画面へ移動します。');
                window.location.href = 'firebase-config.html';
                return false;
            }
            try {
                firebaseConfig = JSON.parse(savedConfig);
                return true;
            } catch (error) {
                alert('設定の読み込みに失敗しました。');
                localStorage.removeItem('firebaseConfig');
                window.location.href = 'firebase-config.html';
                return false;
            }
        }

        // Firebase初期化 (AuthとFirestoreを追加)
        function initializeFirebase() {
            if (!loadFirebaseConfig()) {
                return false;
            }
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                firestore = firebase.firestore();
                db = firebase.database(); // 元のコードが使っているなら残す
                console.log('Firebase初期化成功 (Auth, Firestore)');
                return true;
            } catch (error) {
                console.error('Firebase初期化エラー:', error);
                alert('システムの初期化に失敗しました。設定を確認してください。');
                return false;
            }
        }

        // ============================================
        // グローバル変数
        // ============================================
        
        // 🚨 職員リストとパスワードの配列は「完全に削除」
        // const staff = [ ... ];
        // const passwords = { ... };
        // const leaders = [ ... ];
        // const DEFAULT_ADMIN_PASSWORD = '...';

        // 祝日データ (変更なし)
        const holidays = { '2025-01-01': '元日', ... };

        // 状態管理 (変更なし)
        let currentUser = null; // { uid: '...', name: '長坂', originalId: 1, ... } の形式で保存
        let currentMonth = new Date();
        let selectedDates = {};
        let selectedRequestType = null;
        
        // Admin用
        let staffListForAdmin = []; // 管理者画面で使う職員リスト
        let allRequestsForAdmin = {}; // 管理者画面で使う希望データ

        // ============================================
        // ログイン関連 (🚨 完全に新しいロジック)
        // ============================================
        
        async function login() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            
            // 職員IDから「ダミーメールアドレス」を組み立てる
            // ★★★ ここのドメインをあなたが決めたものにしてください ★★★
            const email = `${userId}@app.com`; // 例: '1@app.com'

            loginButton.disabled = true;
            loginButton.textContent = 'ログイン中...';
            
            try {
                // 1. Firebase Authenticationでログイン
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // 2. Firestoreから職員名簿を取得
                const staffDoc = await firestore.collection('staff').doc(user.uid).get();

                if (!staffDoc.exists) {
                    throw new Error('職員名簿に情報が見つかりません。');
                }

                currentUser = {
                    uid: user.uid,
                    ...staffDoc.data()
                };

                // 3. 初回パスワード変更チェック
                if (currentUser.passwordChanged === false) {
                    // 初回ログイン -> パスワード変更画面へ
                    showChangePasswordSection();
                } else {
                    // 通常ログイン
                    if (currentUser.isAdmin === true) { // 管理者フラグ(isAdmin)をFirestoreに持たせる
                        showAdminSection();
                    } else {
                        showMainSection();
                    }
                }

            } catch (error) {
                console.error('ログインエラー:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    document.getElementById('loginError').textContent = 'IDまたはパスワードが正しくありません';
                } else {
                    document.getElementById('loginError').textContent = 'ログインに失敗しました: ' + error.message;
                }
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'ログイン';
            }
        }

        // パスワード変更 (🚨 完全に新しいロジック)
        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!/^\d{5}$/.test(newPassword)) {
                document.getElementById('passwordError').textContent = '5桁の数字を入力してください';
                return;
            }
            if (newPassword !== confirmPassword) {
                document.getElementById('passwordError').textContent = 'パスワードが一致しません';
                return;
            }

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('ユーザーがログインしていません');
                }

                // 1. Authのパスワードを更新
                await user.updatePassword(newPassword);

                // 2. Firestoreのフラグを更新
                await firestore.collection('staff').doc(user.uid).update({
                    passwordChanged: true
                });

                // 3. メイン画面へ
                alert('パスワードが変更されました。');
                
                // currentUserにも反映
                currentUser.passwordChanged = true;

                if (currentUser.isAdmin === true) {
                    showAdminSection();
                } else {
                    showMainSection();
                }

            } catch (error) {
                console.error('パスワード変更エラー:', error);
                document.getElementById('passwordError').textContent = '変更エラー: ' + error.message;
            }
        }

        // ログアウト (🚨 Authのログアウトを追加)
        async function logout() {
            await auth.signOut();
            
            currentUser = null;
            selectedDates = {};
            selectedRequestType = null;
            
            document.getElementById('userId').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').textContent = '';
            
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('changePasswordSection').classList.add('hidden');
            document.getElementById('syncStatus').classList.add('hidden');
        }


        // ============================================
        // 画面表示 (ロジックはほぼ変更なし)
        // ============================================
        
        function showChangePasswordSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('changePasswordSection').classList.remove('hidden');
        }

        async function showMainSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('changePasswordSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            document.getElementById('syncStatus').classList.remove('hidden');
            
            document.getElementById('welcomeMessage').textContent = currentUser.name + 'さん、こんにちは';
            
            setTargetMonth();
            startCountdown();
            
            // Firestoreからデータを読み込む
            await loadUserRequests();
            renderCalendar();
            
            // 提出状況を更新 (Firestoreから)
            await updateSubmissionStatus();
        }

        async function showAdminSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            document.getElementById('syncStatus').classList.remove('hidden');
            
            currentMonth = new Date();
            
            // 管理者テーブルを描画 (Firestoreから)
            await renderAdminTable();
        }

        // ============================================
        // カレンダー関連 (ロジックはほぼ変更なし)
        // ============================================
        
        function setTargetMonth() { /* ... (変更なし) ... */ }
        function renderCalendar() { /* ... (変更なし) ... */ }
        function formatDate(date) { /* ... (変更なし) ... */ }
        function isDateSelectable(date) { /* ... (変更なし) ... */ }
        function setRequestType(type) { /* ... (変更なし) ... */ }
        function toggleDate(dateString, element) { /* ... (変更なし) ... */ }
        function updateSelectedDatesList() { /* ... (変更なし) ... */ }
        function removeDate(date) { /* ... (変更なし) ... */ }
        function startCountdown() { /* ... (変更なし) ... */ }

        // ============================================
        // 希望管理 (🚨 Firestore版に書き換え)
        // ============================================

        // データをFirestoreに保存
        async function saveRequestsToFirebase(monthKey, staffUid, data) {
            try {
                // ドキュメント: {YYYY-MM}
                // フィールド: { uid: data, uid2: data2 }
                // set + merge:true で、指定したUIDのデータだけを上書き
                const docRef = firestore.collection('requests').doc(monthKey);
                await docRef.set({
                    [staffUid]: data
                }, { merge: true });
                
                console.log('希望データ保存完了:', monthKey, staffUid);
            } catch (error) {
                console.error('希望データ保存エラー:', error);
                throw error;
            }
        }

        // 自分の希望データをFirestoreから読み込む
        async function loadUserRequests() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            const monthKey = year + '-' + String(month).padStart(2, '0');
            
            try {
                const doc = await firestore.collection('requests').doc(monthKey).get();
                
                if (doc.exists && doc.data()[currentUser.uid]) {
                    const submission = doc.data()[currentUser.uid];
                    selectedDates = submission.dates || {};
                } else {
                    selectedDates = {}; // データがない場合はクリア
                }
            } catch (error) {
                console.error("希望の読み込みエラー:", error);
                selectedDates = {};
            }
            
            // 読み込んだらリストも更新
            updateSelectedDatesList();
        }

        // 希望を提出 (🚨 Firestore版)
        async function submitRequests() {
            /* ... (alertやconfirmは変更なし) ... */
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            const monthKey = year + '-' + String(month).padStart(2, '0');
            
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = '送信中...';
            
            try {
                const data = {
                    dates: selectedDates,
                    submittedAt: new Date().toISOString(),
                    staffName: currentUser.name,
                    originalId: currentUser.originalId // originalIdも保存
                };
                
                await saveRequestsToFirebase(monthKey, currentUser.uid, data);
                
                document.getElementById('submitMessage').innerHTML = 
                    '<span class="success-message">希望が提出されました！</span>';
                
                // 提出状況を更新
                await updateSubmissionStatus();

            } catch (error) {
                 document.getElementById('submitMessage').innerHTML = 
                    '<span class="error-message">提出エラー: ' + error.message + '</span>';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '希望を提出';
            }
        }

        // 提出状況の表示 (🚨 Firestore版)
        async function updateSubmissionStatus() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            const monthKey = year + '-' + String(month).padStart(2, '0');

            try {
                // 1. 全職員のリストを取得 (管理者でなくても取得が必要)
                const staffSnapshot = await firestore.collection('staff').get();
                const allStaff = staffSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                
                // 2. その月の希望データを取得
                const requestsDoc = await firestore.collection('requests').doc(monthKey).get();
                const monthRequests = requestsDoc.exists ? requestsDoc.data() : {};

                const submitted = [];
                const notSubmitted = [];

                for (const staff of allStaff) {
                    if (staff.isAdmin) continue; // 管理者は除外
                    
                    if (monthRequests[staff.uid]) {
                        submitted.push(staff.name);
                    } else {
                        notSubmitted.push(staff.name);
                    }
                }
                
                /* ... (innerHTMLにセットするロジックは変更なし) ... */
                const percentage = Math.round((submitted.length / (submitted.length + notSubmitted.length)) * 100);
                document.getElementById('submissionStatusContent').innerHTML = 
                   '<div ...><strong>提出済み (' + submitted.length + '名):</strong> ' + ... + '</div>' +
                   '<div ...><strong>未提出 (' + notSubmitted.length + '名):</strong> ' + ... + '</div>' +
                   '<div ...>提出率: ' + percentage + '%</div>';

            } catch (error) {
                console.error("提出状況の取得エラー:", error);
                document.getElementById('submissionStatusContent').innerHTML = 
                    '<span style="color: red;">提出状況の取得に失敗しました</span>';
            }
        }

        // ============================================
        // 管理者機能 (🚨 Firestore版に書き換え)
        // ============================================
        
        async function renderAdminTable() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            const monthKey = year + '-' + String(month).padStart(2, '0');
            
            document.getElementById('adminMonth').textContent = year + '年' + month + '月の希望一覧';
            
            try {
                // 1. 全職員のリストを取得
                const staffSnapshot = await firestore.collection('staff')
                    .orderBy('originalId', 'asc') // originalIdで並び替え
                    .get();
                staffListForAdmin = staffSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));

                // 2. その月の希望データを取得
                const requestsDoc = await firestore.collection('requests').doc(monthKey).get();
                allRequestsForAdmin = requestsDoc.exists ? requestsDoc.data() : {};
                
                // 3. テーブルヘッダーを描画 (変更なし)
                const header = document.getElementById('adminTableHeader');
                header.innerHTML = '<th>ID</th><th>チーム</th><th>職員名</th>';
                const daysInMonth = new Date(year, month, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    header.innerHTML += '<th>' + day + '</th>';
                }

                // 4. テーブルボディを描画
                const tbody = document.getElementById('adminTableBody');
                tbody.innerHTML = '';
                
                for (const staffMember of staffListForAdmin) {
                    if (staffMember.isAdmin) continue; // 管理者は一覧から除外

                    let row = '<tr>';
                    row += `<td>${staffMember.originalId || ''}</td>`;
                    row += `<td>${staffMember.team || ''}</td>`; // Firestoreに 'team' フィールドを持たせる
                    
                    let nameDisplay = staffMember.name;
                    if (staffMember.leader) { // Firestoreに 'leader' フィールドを持たせる
                        nameDisplay += ' <span style="color: #ff9800; font-weight: bold;">L</span>';
                    }
                    row += `<td>${nameDisplay}</td>`;

                    // 希望データを描画
                    const staffRequestData = allRequestsForAdmin[staffMember.uid];
                    const dates = staffRequestData ? staffRequestData.dates : {};

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                        const cellContent = dates[dateString] || '';
                        let cellStyle = '';
                        /* ... (cellStyleのロジックは変更なし) ... */
                        row += `<td style="${cellStyle}">${cellContent}</td>`;
                    }
                    
                    row += '</tr>';
                    tbody.innerHTML += row;
                }

            } catch (error) {
                console.error("管理者テーブルの描画エラー:", error);
                document.getElementById('adminTableBody').innerHTML = 
                    `<tr><td colspan="34" style="color: red;">データ取得エラー: ${error.message}</td></tr>`;
            }
        }

        // 月移動 (変更なし)
        async function showPreviousMonth() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            await renderAdminTable();
        }
        async function showCurrentMonth() {
            currentMonth = new Date();
            await renderAdminTable();
        }
        async function showNextMonth() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            await renderAdminTable();
        }

        // CSVエクスポート (🚨 Firestoreの変数を使うように変更)
        function exportToCSV() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            
            let csv = 'ID,チーム,職員名';
            const daysInMonth = new Date(year, month, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) { csv += ',' + day + '日'; }
            csv += '\n';
            
            // staffListForAdmin と allRequestsForAdmin を使う
            staffListForAdmin.forEach(staffMember => {
                if (staffMember.isAdmin) return;

                csv += `${staffMember.originalId || ''},`;
                csv += `${staffMember.team || ''},`;
                
                let name = staffMember.name;
                if (staffMember.leader) { name += '(L)'; }
                csv += name;

                const staffRequestData = allRequestsForAdmin[staffMember.uid];
                const dates = staffRequestData ? staffRequestData.dates : {};
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    csv += ',' + (dates[dateString] || '');
                }
                csv += '\n';
            });
            
            /* ... (Blobとダウンロードのロジックは変更なし) ... */
             const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
             const link = document.createElement('a');
             link.href = URL.createObjectURL(blob);
             link.download = 'shift_requests_' + year + '_' + month + '.csv';
             link.click();
        }

        // ============================================
        // 初期化処理 (変更なし)
        // ============================================
        
        // 同期状態 (変更なし)
        function updateSyncStatus(status) { /* ... (変更なし) ... */ }
        function setupRealtimeSync() {
             // (元のコードがRTDBを使っていたなら、そのロジックをここに残す)
             // ...
             // Firestoreのリアルタイム同期は .onSnapshot() を使いますが、
             // ひとまず .get() での読み込みで実装しています。
        }

        window.addEventListener('DOMContentLoaded', async function() {
            console.log('ページ読み込み完了');
            
            if (!initializeFirebase()) {
                document.getElementById('loadingSection').innerHTML = '<div class...';
                return;
            }
            
            try {
                // リアルタイム同期設定 (もしあれば)
                // setupRealtimeSync();
                
                // ログイン画面表示
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('loginSection').classList.remove('hidden');
                
                // Enterキーでログイン (変更なし)
                document.getElementById('password').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
                
                console.log('システム初期化完了');
            } catch (error) {
                console.error('初期化エラー:', error);
                document.getElementById('loadingSection').innerHTML = '<div class...';
            }
        });
    </script>
</body>
</html>
